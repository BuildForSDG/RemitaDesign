!function(){"use strict";function h(e,t){this.container=t,this.sdpConstraints={offerToReceiveAudio:!0,offerToReceiveVideo:!1},this.audio="audio",this.screen_share="screen_share",this.init(e)}h.prototype.init=function(e){this.chid=e.chatid,this.mid=e.id,this.type=e.type,this.localDescription="",this.remoteDescription="",this.localStream="",this.remoteStream="",this.localIceCandidates=[],this.remoteIceCandidates=[],this.iceRestart=e.iceRestart,this.isUpStream=e.isUpStream,this.connectionStatus="",this.rtcConnection="",this.isReconnecting=!1,this.streamData=null,this.remoteCandidatePushed=!1,this.mediaRequest=e.mediaRequest,this.intRTCConn(),this.reconnectInterval=null,this.statsObj=null,this.reconnectEndTimer=null},h.prototype.intRTCConn=function(){try{this.rtcConnection=new RTCPeerConnection(this.getCredentail()),this.localStream=this.container.MediaPermission.getStreamByType(this.type),this.isUpStream&&this.createOffer(),this.getRemoteStream(),this.rtcConnectionStatus()}catch(e){}},h.prototype.getCredentail=function(){var e=this.mid,t=this.container.dataHandler.get(e+"_credential");if(t.credential){var i=JSON.parse(t.credential),n=i.servers.split(","),a=i.user_name,o=i.token,r=[];return n.forEach(function(e){r.push({urls:e,username:a,credential:o})}),{iceServers:r}}return null},h.prototype.createOffer=function(){var t=this;!this.iceRestart&&this.localStream&&this.addStream();var e=this.getSDPConstraints();this.iceRestart&&(e.iceRestart=!0),this.rtcConnection.createOffer(e).then(function(e){t.offerSuccessCallBack(e)}).catch(function(e){t.offerErrorCallBack(e)})},h.prototype.offerSuccessCallBack=function(e){this.localDescription=e,this.rtcConnection.setLocalDescription(new RTCSessionDescription(e));var t={description:e},i=this.contructResponse(t),n=this.type+"Impl";this.container[n].sendOffer(i),this.createIceCandidates()},h.prototype.offerErrorCallBack=function(){},h.prototype.createAnswer=function(){var t=this;this.rtcConnection.createAnswer(this.sdpConstraints).then(function(e){t.answerSuccessCallBack(e)}).catch(function(e){t.answerErrorCallBack(e)})},h.prototype.answerSuccessCallBack=function(e){this.localDescription=e,this.rtcConnection.setLocalDescription(new RTCSessionDescription(e));var t={description:e},i=this.contructResponse(t),n=this.type+"Impl";this.container[n].sendAnswer(i)},h.prototype.addStream=function(){var t=this;this.localStream&&this.localStream.getTracks().forEach(function(e){t.streamData="function"==typeof t.rtcConnection.addTrack?t.rtcConnection.addTrack(e,t.localStream):t.rtcConnection.addStream(t.localStream)})},h.prototype.createIceCandidates=function(){this.localIceCandidates=[],this.rtcConnection.onicecandidate=function(e){this.localIceCandidates.push(e);var t,i,n,a={};e.candidate&&(a.label=e.candidate.sdpMLineIndex,a.type="candidate",a.id=e.candidate.sdpMid,a.candidate=e.candidate.candidate,t={candidates:this.container.detailsHandler.toJSON(a)},i=this.contructResponse(t),n=this.type+"Impl",this.container[n].sendCandidate(i))}.bind(this)},h.prototype.setRemoteDescription=function(e){var t=this;this.isUpStream||this.isReconnecting||this.iceRestart||this.addStream(),this.rtcConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(e))).then(function(){t.isUpStream||(t.createAnswer(),t.createIceCandidates()),t.clearReconnectNWTimer()}),this.remoteDescription=e,this.remoteCandidatePushed||this.pushIceCandidate()},h.prototype.pushIceCandidate=function(){if(this.remoteIceCandidates&&0<this.remoteIceCandidates.length){for(var e in this.remoteIceCandidates){var t=this.remoteIceCandidates[e],i=new RTCIceCandidate({sdpMid:t.id,sdpMLineIndex:t.label,candidate:t.candidate});this.rtcConnection.addIceCandidate(i)}this.remoteCandidatePushed=!0}},h.prototype.setIceCandidates=function(e){var t,i=e.candidates?JSON.parse(e.candidates):JSON.parse(e.msg.candidate);this.remoteDescription&&this.localDescription?(this.remoteIceCandidates&&0<this.remoteIceCandidates.length&&!this.remoteCandidatePushed&&this.pushIceCandidate(),t=new RTCIceCandidate({sdpMid:i.id,sdpMLineIndex:i.label,candidate:i.candidate}),this.rtcConnection.addIceCandidate(t)):(this.remoteIceCandidates&&0<this.remoteIceCandidates.length||(this.remoteIceCandidates=[]),this.remoteIceCandidates.push(i))},h.prototype.rtcConnectionStatus=function(){var i=this;this.rtcConnection.oniceconnectionstatechange=function(){var e,t=i.rtcConnection.iceConnectionState;"connected"==t?(e=i.type+"Impl",i.container[e].callConnected(i),i.container.commonImpl.clearNetworkTimer(i)):"failed"==t&&i.initReconnect()},this.rtcConnection.onconnectionstatechange=function(e){"failed"==i.rtcConnection.connectionState&&i.initReconnect()}},h.prototype.initReconnect=function(){this.isReconnecting=!0,this.iceRestart=!0,this.remoteIceCandidates=[],this.remoteDescription=null,this.remoteCandidatePushed=!1,this.container.commonImpl.checkNetwork(this.chid,this.mid)},h.prototype.getRemoteStream=function(){var i=this;this.rtcConnection.onaddstream=this.rtcConnection.ontrack=function(e){var t=i.type;i.remoteStream=e,i.container[t+"Impl"].addRemoteStream(e,i)}},h.prototype.contructResponse=function(e){var t=this.mid,i=this.type,n=this.chid;return Object.assign({},{mid:t,type:i,chid:n},e)},h.prototype.closeConnection=function(){try{this.rtcConnection.close(),this.localStream&&this.closeTracksInStream(this.localStream)}catch(e){}},h.prototype.closeTracksInStream=function(e){try{var t=e.getTracks();for(var i in t)t[i].stop()}catch(e){}},h.prototype.getSDPConstraints=function(){var e=this.type,t=this.mid,i=this.chid,n=(this.container.dataHandler.get(i+"_call_status",!0)||{})[t].mediarequest,a={offerToReceiveAudio:!0,offerToReceiveVideo:!0};return e==this.audio?a.offerToReceiveVideo=!1:e==this.screen_share&&(a.offerToReceiveVideo=n,a.offerToReceiveAudio=!1),a},h.prototype.clearReconnectNWTimer=function(){this.reconnectInterval&&(clearInterval(this.reconnectInterval),this.reconnectInterval=null,this.iceRestart=!1)};function e(e){((this.container=e).audioImpl=this).init(),this.audio="audio",this.timeout={},this.iconClicked={}}e.prototype.setCredential=function(e){this.container.commonImpl.setCredential(e)},e.prototype.handleInvitation=function(e,t){var i=this;void 0===t&&(t=0);var n=e.chatid,a=e.id,o=(e.mode,e.type),r=e.mediaRequest,c=this.container.constants.WAITING_TIME_SECS;if(this.container.detailsHandler.canShowAudioCallInvitation(n))try{var s,l,d=function(){clearTimeout(i.timeout[a]),i.handleUIReject(o,n,a)},u={chid:n,media_id:a,rejectCbk:d,acceptCbk:function(){clearTimeout(i.timeout[a]),i.handleUIAccept(o,n,a,e.mediaInvitation)}};if(this.container.commonImpl.checkIncomingCallAllowed(e))return this.container.commonImpl.makeCallReject(o,a),!0;this.setCredential(e),e.mediaInvitation?(setTimeout(function(){i.container.uiHandler.handleAudioCallInvite(o,u)},500),this.container.commonImpl.setCallStatus(n,a,o,"incoming","ringing",r,"downstream"),l={type:"audiocall",duration:(s=this.container.commonImpl.getActiveTab())?"3":c,tone:s?"outgoingcall":"incomingcall",chatid:n,isEncrypted:!1},this.container.commonImpl.playMediaNotificationSound(l),this.container.commonImpl.showDesktopNotif({chatid:n}),this.timeout[a]=setTimeout(d,65e3)):(this.container.commonImpl.setCallStatus(n,a,o,"incoming","connecting",r,"downstream"),this.handleUIAccept(o,n,a,e.mediaInvitation)),this.container.commonImpl.updateIncomingRequestData(e);var p="siqMedia: media invitation  | chid :"+n+" | mediaid : "+a+" | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,p),this.container.detailsHandler.triggerIconCheck(n)}catch(e){}else t<3&&(0==t&&this.container.detailsHandler.joinChat(n),setTimeout(function(){return i.handleInvitation(e,t++)},3e3))},e.prototype.callConnected=function(e){var t=this,i=e.chid,n=e.type,a=e.mid,o=this.container.commonImpl.getCallStatusByChid(i)[a].isdirectcall,r=(r=localStorage.getItem("siq_directcall"))&&JSON.parse(r);clearTimeout(this.container.dataHandler.get(a+"_connecting_timer"));var c={chid:i,callEndCbk:o?function(){return t.handleUIApiCallEnd(i,n,a)}:function(){t.container.commonImpl.makeCallEnd(n,a),t.handleCallEnd({chatid:e.chid,type:n,id:a})},muteCbk:function(){return t.toggleMute()},media_id:a,isDirectCall:o};this.container.uiHandler.updateCallInvitationState("audio",c,"connected"),this.container.commonImpl.updateCallStatus(i,a,"connected"),this.container.commonImpl.getEligibleMediaAction(e.chid,n),this.container.detailsHandler.triggerIconCheck(i),this.container.commonImpl.sendMediaStats({id:a},"call connected ");var s="siqMedia: Audio call connected  | chid :"+i+" | mediaid : "+a+" | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,s);var l=this.container.dataHandler.get(i+"_peer");l&&l[a]&&l.reconnectEndTimer&&clearTimeout(l.reconnectEndTimer),e.isReconnecting=!1,r&&o&&(r.status="connected",localStorage.setItem("siq_directcall",JSON.stringify(r))),this.container.commonImpl.updateMediaStatsDetail({connectedTime:Date.now(),isreconnected:e.isReconnecting,mediaid:a});var d=this.container.commonImpl.getConnectedStatsDetail(a);this.container.commonImpl.makeCallConnected(d)},e.prototype.handleCallAccept=function(e){var t=this,i=e.chatid,n=e.id,a=e.type,o=this.container,r=o.constants.WAITING_TIME,c=i+"_peer",s=o.dataHandler.get(c)||{},l=o.commonImpl.getCallStatusByChid(i);e.isUpStream=!0,e.iceRestart=!1,s[n]=new h(e,o),clearTimeout(o.dataHandler.get(n+"_waiting_timer")),o.dataHandler.remove(n+"_waiting_timer"),o.dataHandler.set(c,s),o.commonImpl.updateCallStatus(i,n,"connecting"),o.dataHandler.set(n+"_connecting_timer",setTimeout(function(){o.commonImpl.makeCallEnd(a,n),t.clearData({type:a,chatid:i,id:n}),o.uiHandler.updateCallInvitationState("audio",{chid:i,media_id:n},"ended")},r));var d={chid:i,media_id:n,isDirectCall:l[n].isdirectcall,muteCbk:function(){return t.toggleMute()},rejectCbk:function(){return"upstream"==l[n].host?t.container.commonImpl.makeCallCancel(a,n):t.container.commonImpl.makeCallReject(a,n)}};o.uiHandler.updateCallInvitationState("audio",d,"connecting"),this.container.commonImpl.stopNotificationSound();try{var u={acceptedTime:Date.now(),callerType:0,lsid:this.container.detailsHandler.getLsid(i),reconnectCount:0,type:a,mediaid:n};this.container.commonImpl.setMediaStatsDetail(u)}catch(e){}var p="siqMedia: call accept request received  | chid :"+i+" | mediaid : "+n+" | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,p)},e.prototype.handleCallReject=function(e){var t=e.chatid,i=e.id,n=this.container,a=n.commonImpl.getCallStatusByChid(t),o={chid:t,media_id:i,isDirectCall:a[i].isdirectcall};this.clearData(e),n.uiHandler.updateCallInvitationState("audio",o,"rejected"),clearTimeout(n.dataHandler.get(i+"_waiting_timer")),clearTimeout(n.dataHandler.get(i+"_connecting_timer")),delete a[i],n.commonImpl.removeCredential(i);var r="siqMedia: call reject request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,r)},e.prototype.handleCandidates=function(e){var t=this.container,i=t.dataHandler.get(e.chatid+"_peer")[e.id];i||((i={})[e.id]=new h(e,t),t.dataHandler.set(e.chatid+"_peer",i),i=i[e.id]),i.setIceCandidates(e)},e.prototype.handleCallAnswer=function(e){var t=this.container.dataHandler.get(e.chatid+"_peer")[e.id],i=e.session;t.setRemoteDescription(i)},e.prototype.handleCallEnd=function(e){var t=this.container.commonImpl.getCallStatusByChid(e.chatid),i={chid:e.chatid,media_id:e.id,isDirectCall:t[e.id].isdirectcall};this.clearData(e),this.container.uiHandler.updateCallInvitationState("audio",i,"ended")},e.prototype.handleCallOffer=function(e){var t=e.chatid,i=e.id,n=e.session,a=this.container,o=t+"_peer",r=a.dataHandler.get(o)||{};e.isUpStream=!1,e.iceRestart=!1;var c=r[i];r[i]||(r[i]=new h(e,a),a.dataHandler.set(t+"_peer",r),c=r[i]),c.setRemoteDescription(n)},e.prototype.handleCallCancel=function(e){try{var t=e.chatid,i=e.id,n=(e.type,this.container),a={chid:t,media_id:i,isDirectCall:n.commonImpl.getCallStatusByChid(t)[i].isdirectcall};n.commonImpl.removeCredential(i),n.uiHandler.updateCallInvitationState("audio",a,"cancelled"),clearTimeout(this.timeout[i]),clearTimeout(n.dataHandler.get(i+"_waiting_timer")),clearTimeout(n.dataHandler.get(i+"_connecting_timer"));var o="siqMedia: call cancel request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,o),this.clearData(e)}catch(e){}},e.prototype.clearData=function(e){try{var t=this.container,i=e.type,n=e.chatid||e.chid,a=e.id||e.mid,o="siqMedia: before clearing Audio call data  | chid :"+n+" | mediaid : "+a+" | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,o);var r=t.commonImpl;this.closePeerConn(e),r.removeCredential(a),r.checkAVIcon(n),r.clearCallDetails(n,a),r.getActiveCallData()&&r.getActiveCallData()==n&&!r.getCallStatusByChid(n)&&(t.commonImpl.removeActiveCallData(),r.removeActiveTab(),this.clearMediaPermision(i)),r.removeIncomingRequestData(n),r.stopNotificationSound(),r.checkAndPlayNotification(),t.detailsHandler.triggerIconCheck(n),r.clearConnectedStatsDetail(a)}catch(e){}},e.prototype.handleCallInvite=function(){},e.prototype.closePeerConn=function(e){var t=e.chatid||e.chid,i=e.id||e.mid,n=e.type;try{var a=this.container.dataHandler.get(t+"_peer");a[i].closeConnection(),delete a[i],this.clearMediaPermision(n),this.removeAudioPlayer()}catch(e){var o="siqMedia: error while clearing peer connection  | chid :"+t+" | mediaid : "+i+" | curUserId : "+this.container.detailsHandler.getCurrentUserId()+" | error msg :"+e;this.callBackAction(this.implConstants.postDebugLog,o)}},e.prototype.clearMediaPermision=function(e){this.container.MediaPermission.closeStreamByType(e)},e.prototype.startAudioCall=function(e){var t=this,i=this.container.commonImpl.getActiveCallData();if(!this.iconClicked[e.chatid]){if(this.iconClicked[e.chatid]=!0,i){var n=this.container.commonImpl.getCallStatusByChid(i);for(var a in n)if("audio"==n[a].type)return void delete this.iconClicked[e.chatid]}try{var o=e.chatid,r=this.container.detailsHandler.isembed;if("visitor"!=e.mode||(!!r||this.isAudioCallAllowed(e))){if(this.container.detailsHandler.isAudioCallDisabled(o))return void delete this.iconClicked[e.chatid];var c=function(){clearTimeout(s)},s=setTimeout(function(){c=t.container.uiHandler.mediaPermissionUI()},3e3);this.container.MediaPermission.getAudioStream(function(){c(),t.onMediaPermissionSuccess(e).call(t)},this.onUpStreamMediaPermissionFailure(function(){return c()},o))}else{var l="siqMedia: To start AUDIO call - permission checks failed | chid - "+o+" ";this.callBackAction(this.implConstants.postDebugLog,l),delete this.iconClicked[e.chatid]}}catch(e){}}},e.prototype.constructResponeObj=function(e){return Object.assign({},{type:"audio"},e)},e.prototype.onMediaPermissionSuccess=function(e){var t=this;try{var i=this.container.constants.WAITING_TIME_SECS;e.mode=e.mode?e.mode:"visitor";var n=this.constructResponeObj(e);this.container.commonImpl.setActiveTab(),n.mediainvitation=e.mediainvitation||!1,n.mediarequest=e.mediarequest||!1;var a=this.container.commonImpl.constructURL(null,null);this.container.commonImpl.setActiveCallData(e.chatid);var o={type:"audiocall",duration:i,tone:"outgoingcall",chatid:e.chatid,isEncrypted:!0};return this.container.commonImpl.playMediaNotificationSound(o),function(){t.container.ajaxHandler.post(a,n,t.onstarted.bind(t),t.startCallFailure.bind(t))}}catch(e){}},e.prototype.onUpStreamMediaPermissionFailure=function(n,a){var o=this;return function(e,t){n();var i=o.container.commonImpl.getFailureMessage(e);o.container.uiHandler.mediaPermissionUnlock(),o.container.uiHandler.showDialog({desc:i,buttons:{accept:{text:"common.ok",callback:function(){return null}}}}),delete o.iconClicked[a]}},e.prototype.onDownStreamMediaPermissionFailure=function(n){var a=this;return function(e,t){try{n.cbk(),a.container.uiHandler.mediaPermissionUnlock();var i=a.container.commonImpl.getFailureMessage(e);a.container.commonImpl.makeCallReject("audio",n.id),a.container.uiHandler.updateCallInvitationState("audio",{chid:n.chatid,media_id:n.id},"rejected"),a.container.uiHandler.showDialog({desc:i})}catch(e){}}},e.prototype.isAudioCallAllowed=function(e){var t=e.chatid;try{var i=this.container.detailsHandler.getVisitorBrowser(t),n=this.container.detailsHandler.getVisitorPage(t),a=!0,o="",r="";return this.container.commonImpl.getMediaDataByChidAndType({chatid:t,type:this.audio})?!1:(this.container.detailsHandler.isChatMonitor(t)?(r="AUDIO - call Not Allowed because chat is in monitor | chid - "+t+" | visitorId - ",o=this.container.detailsHandler.I18N("av.info.chatinvite"),a=!1):"Google Chrome"!==i&&"Mozilla Firefox"!==i&&"Apple Safari"!==i&&"Opera"!==i?(o=this.container.detailsHandler.I18N("av.info.visitorbrowsernotsupported"),r="AUDIO call - Failed visitor browser not supported | chid - "+t+" | visitorId -  | browser-"+i,a=!1):this.container.MediaDetails.checkBrowserSupported()?"https"!=n.substring(0,5)?(o=this.container.detailsHandler.I18N("av.info.insecuredwebsite"),r="AUDIO call-Failed Visitor not in secure connection | chid - "+t+" |  visitorId - ",a=!1):this.container.detailsHandler.isGroupConversation(t)?(o=this.container.detailsHandler.I18N("av.info.chatinvite"),r="AUDIO call-Failed Visitor not in secure connection | chid - "+t+" |  visitorId - ",a=!1):this.container.detailsHandler.isAttenderBot(t)?(r="AUDIO call-Failed bot attender | chid - "+t+" |  visitorId - ",a=!1):this.container.detailsHandler.isFaceBookIntegration(t)&&(o=this.container.detailsHandler.I18N("av.info.facebookpagenotsupported"),r="AUDIO call-Failed Visitor is in Facebook page | chid - "+t+" |  visitorId - ",a=!1):(r="AUDIO call-Failed agent browser not supported| chid - "+t,a=!1),a||(this.container.uiHandler.showDialog({desc:o,ok:{text:"common.ok",callback:function(){}}}),this.callBackAction(this.implConstants.postDebugLog,r)),a)}catch(e){var c="failed in isAudioCallAllowed method | chid - "+t;this.callBackAction(this.implConstants.postDebugLog,c)}},e.prototype.sendOffer=function(e){this.container.commonImpl.sendOffer(e)},e.prototype.sendAnswer=function(e){this.container.commonImpl.sendAnswer(e)},e.prototype.sendCandidate=function(e){this.container.commonImpl.sendCandidate(e)},e.prototype.postDebugLog=function(e){this.container.detailsHandler.sendDebugLogger(e,null,null,!0)},e.prototype.callBackAction=function(e,t){({postDebugLog:this.postDebugLog.bind(this)})[e](t)},e.prototype.init=function(){this.implConstants={postDebugLog:"postDebugLog"}},e.prototype.addRemoteStream=function(e,t){try{var i="siqMedia: adding remote stream  | chid :"+t.chid+" | mediaid : "+t.mid+" | lsuid : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,i);var n="",a=e.stream;t.type==this.audio&&(n=this.addAudioPlayer()),e.streams&&(a=e.streams[0]);try{n.srcObject=a}catch(e){n.src=window.URL.createObjectURL(a)}this.container.commonImpl.checkAndUpdateUIForApi()}catch(e){var o="siqMedia: adding remote stream  | chid :"+t.chid+" | mediaid : "+t.mid+" | lsuid : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,o)}},e.prototype.addAudioPlayer=function(){try{var e="siqMedia: creating audio player stream  | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,e);var t=document.querySelector("#remoteaudio");if(null!=t&&null!=t&&0!=t.length)return t[0];var i=document.createElement("audio");return i.id="remoteaudio",i.autoplay=!0,document.querySelector("body").appendChild(i),i}catch(e){}},e.prototype.removeAudioPlayer=function(){var e=document.querySelector("#remoteaudio");e.parentNode.removeChild(e)},e.prototype.startCallFailure=function(){this.iconClicked={},callBackAction()},e.prototype.startcall=function(e,t,i){var n={},a=this.container;n.type=e,n.chatid=t,n.mode=i||"visitor";var o=a.commonImpl.constructURL(null,null);a.commonImpl.setActiveCallData(t),a.ajaxHandler.post(o,n,this.onstarted,this.startCallFailure)},e.prototype.handleUIReject=function(e,t,i){var n=this.container,a=n.commonImpl.getCallStatusByChid(t);n.uiHandler.updateCallInvitationState("audio",{chid:t,media_id:i,isDirectCall:a[i].isdirectcall},"rejected"),this.container.commonImpl.makeCallReject(e,i),this.clearData({type:e,chatid:t,id:i});var o=" reject trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,o)},e.prototype.handleUIEnd=function(e,t,i){try{var n={chid:t,media_id:i,isDirectCall:call_status[id].isdirectcall};this.container.commonImpl.makeCallEnd(e,i),this.container.uiHandler.updateCallInvitationState("audio",n,"rejected"),this.container.detailsHandler.triggerIconCheck(t),this.clearData({type:e,chatid:t,id:i})}catch(e){}},e.prototype.endOngoingCall=function(e,t,i){var n=this.container,a=n.dataHandler.get(e+"_peer");if(a)for(var o in a){var r=a[o];this.container.uiHandler.updateCallInvitationState(r.type,{chid:e,media_id:r.mid},"ended"),this.container.commonImpl.makeCallEnd(r.type,r.mid,i),this.clearData(r),delete a[o]}else{this.container.commonImpl.makeCallEnd("audio",t,i),this.clearData({type:"audio",chatid:e,id:t})}n.commonImpl.removeActiveCallData(e)},e.prototype.__handleUIAccept=function(i,n,a){var o=this,r=this.container,c=this.container.commonImpl.getActiveCallData(),s=r.commonImpl.getCallStatusByChid(c),l=r.commonImpl.getCallStatusByChid(n);if(this.container.detailsHandler.focusChatWindow(n),c&&c!=n){for(var e in s)!function(e){var t=s[e],i=t.type+"Impl",n=t.callStatus;"connected"==n?o.container[i].endOngoingCall(c,e,function(){return t.isdirectcall&&r.detailsHandler.endSession(c)}):"ringing"!=n&&"connecting"!=n||(("upstream"==s[e].host?o.container[i].handleUICancel.bind(o):o.container[i].handleUIReject.bind(o))(t.type,c,t.id),r.commonImpl.removeActiveCallData())}(e)}var d=function(){clearTimeout(t)},t=setTimeout(function(){d=o.container.uiHandler.mediaPermissionUI()},3e3);this.container.MediaPermission.getAudioStream(function(){d(),o.container.commonImpl.updateCallStatus(n,a,"connecting"),o.container.commonImpl.setActiveCallData(n),o.container.commonImpl.makeCallAccept("audio",a);var e={chid:n,media_id:a,muteCbk:function(){return o.toggleMute()},rejectCbk:function(){return"upstream"==l[a].host?o.handleUICancel(i,n,a):o.handleUIReject(i,n,a)}};r.uiHandler.updateCallInvitationState("audio",e,"connecting");var t=r.constants.WAITING_TIME;r.dataHandler.set(a+"_connecting_timer",setTimeout(function(){r.commonImpl.makeCallEnd(i,a),o.clearData({type:i,chatid:n,id:a}),r.uiHandler.updateCallInvitationState("audio",{chid:n,media_id:a},"ended")},t))},this.onDownStreamMediaPermissionFailure({chatid:n,id:a,cbk:d})),this.container.commonImpl.removeIncomingRequestData(n),this.container.commonImpl.setActiveTab(),this.container.commonImpl.stopNotificationSound()},e.prototype.handleUIAccept=function(e,t,i,n){var a=this,o=this.container.commonImpl.getActiveCallData();o&&o!=t?this.container.uiHandler.handleCallClash(function(){return a.__handleUIAccept(e,t,i,n)},function(){return a.handleUIReject(e,t,i)}):this.__handleUIAccept(e,t,i,n);var r={acceptedTime:Date.now(),callerType:1,lsid:this.container.detailsHandler.getLsid(t),reconnectCount:0,type:e,mediaid:i};this.container.commonImpl.setMediaStatsDetail(r)},e.prototype.handleUICancel=function(e,t,i){this.container.uiHandler.updateCallInvitationState(e,{chid:t,media_id:i},"cancelled"),this.container.commonImpl.makeCallCancel(e,i),this.clearData({type:e,chatid:t,id:i});var n=" reject trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,n)},e.prototype.toggleMute=function(){this.container.MediaPermission.toggleMute()},e.prototype.startVisitorAudioCall=function(e){var t={chatid:e,mode:"visitor",mediarequest:!0,mediainvitation:!0,type:"audio"};this.startAudioCall(t)},e.prototype.handleCallMissed=function(e){try{var t=e.chatid,i=e.id;this.clearData(e);var n={chid:t,media_id:i};this.container.uiHandler.updateCallInvitationState("audio",n,"missed")}catch(e){var a=" call missed  | chid :"+chatid+" | mediaid : "+id+" | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,a)}},e.prototype.acceptAudioCallForDsk=function(e){var t=this.container.commonImpl.getMediaDataByChidAndType({chatid:e,type:this.audio}).id;this.__handleUIAccept(this.type,e,t,!0),this.container.uiHandler.clearAudioCallInvite(this.audio,t)},e.prototype.rejectAudioCallForDsk=function(e){var t=this.container.commonImpl.getMediaDataByChidAndType({chatid:e,type:this.audio}).id;this.handleUIReject(this.type,e,t),this.container.uiHandler.clearAudioCallInvite(this.audio,t)},e.prototype.hasIncommingCall=function(e){var t=this.container.commonImpl.getCallStatusByChid(e);for(var i in t){var n=t[i];if("audio"==n.type&&"incoming"==n.callType&&"ringing"==n.callStatus)return!0}return!1};function t(e){e.videoImpl=this}t.prototype.handleInvitation=function(){},t.prototype.handleCallAccept=function(){},t.prototype.handleCallReject=function(){},t.prototype.handleCandidates=function(){},t.prototype.handleCallAnswer=function(){},t.prototype.handleCallEnd=function(){},t.prototype.handleCallOffer=function(){},t.prototype.handleCallCancel=function(){},t.prototype.handleCallCancel=function(){},t.prototype.handleCallInvite=function(){};function i(e){(e.screenShareImpl=this).container=e,this.init(),this.timeout={}}i.prototype.setCredential=function(e){this.container.commonImpl.setCredential(e)},i.prototype.handleInvitation=function(e){var t=this,i=e.chatid,n=e.id,a=e.type,o=this.container.commonImpl.getActiveCallData();if(this.container.detailsHandler.isEmbed()||o&&o==i){var r=function(){clearTimeout(t.timeout[n]),t.handleUIReject(a,i,n)},c={chid:i,media_id:n,rejectCbk:r,acceptCbk:function(){clearTimeout(t.timeout[n]),t.handleUIAccept(a,i,n)}};if(this.container.commonImpl.checkIncomingCallAllowed(e))return this.container.commonImpl.makeCallReject(a,n),!0;this.setCredential(e),e.mediaInvitation?(this.container.uiHandler.handleAudioCallInvite("screen_share",c),this.container.commonImpl.setCallStatus(i,n,a,"incoming","ringing",e.mediaRequest,"downstream"),this.timeout[n]=setTimeout(r,65e3)):(this.container.commonImpl.setCallStatus(i,n,a,"incoming","connecting",e.mediaRequest,"downstream"),e.mediaRequest?this.container.MediaPermission.getScreenShareStream(function(){t.container.commonImpl.makeCallAccept("screen_share",n),t.container.MediaPermission.screenEndFromBrowserUI(function(){return t.handleUIEnd({type:a,id:n,chatid:i})})},this.onMediaPermissionFailure(i,n)):(this.container.commonImpl.setActiveCallData(i),this.container.commonImpl.makeCallAccept("screen_share",n)),this.container.commonImpl.setActiveTab())}},i.prototype.handleCallAccept=function(e){var t=this,i=e.chatid,n=e.id,a=e.type,o=this.container,r=i+"_peer",c=o.dataHandler.get(r)||{};e.isUpStream=!0,e.iceRestart=!1,c[n]=new h(e,o),o.dataHandler.set(r,c),clearTimeout(o.dataHandler.get(n+"_waiting_timer")),o.dataHandler.remove(n+"_waiting_timer");var s={chid:i,media_id:n,muteCbk:function(){},rejectCbk:function(){o.commonImpl.makeCallCancel(a,n),o.uiHandler.updateCallInvitationState(a,{chid:i,media_id:n},"cancelled"),t.clearData({type:a,chatid:i,id:n})}};this.container.commonImpl.updateCallStatus(i,n,"connecting"),o.uiHandler.updateCallInvitationState(o.constants.screen_share,s,o.constants.connecting)},i.prototype.handleCallReject=function(e){var t=e.chatid,i=e.id,n=e.type;this.container.uiHandler.updateCallInvitationState("screen_share",{chid:t,media_id:i},"rejected"),this.clearData({type:n,chatid:t,id:i})},i.prototype.handleCandidates=function(e){var t=this.container,i=this.container.dataHandler.get(e.chatid+"_peer")[e.id];i||((i={})[e.id]=new h(e,t),t.dataHandler.set(e.chatid+"_peer",i),i=i[e.id]),i.setIceCandidates(e)},i.prototype.handleCallAnswer=function(e){var t=this.container.dataHandler.get(e.chatid+"_peer")[e.id],i=e.session;t.setRemoteDescription(i)},i.prototype.handleCallEnd=function(e){var t=e.type,i=e.id,n=e.chatid;this.container.uiHandler.updateCallInvitationState(t,{chid:n,media_id:i},"ended"),this.container.detailsHandler.clearPlayer(),this.clearData({type:t,chatid:n,id:i})},i.prototype.handleCallOffer=function(e){var t=e.chatid,i=e.id,n=e.session,a=this.container,o=t+"_peer",r=a.dataHandler.get(o)||{};e.isUpStream=!1,e.iceRestart=!1;var c=r[i];r[i]||(r[i]=new h(e,a),a.dataHandler.set(t+"_peer",r),c=r[i]),c.setRemoteDescription(n)},i.prototype.handleCallCancel=function(e){var t=e.chatid,i=e.id,n=(e.type,this.container),a={chid:t,media_id:i};n.commonImpl.removeCredential(i),n.uiHandler.updateCallInvitationState("screen_share",a,"cancelled"),this.clearData(e),clearTimeout(this.timeout[i]);var o="siqMedia: call cancel request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,o)},i.prototype.handleUIReject=function(e,t,i){this.container.uiHandler.updateCallInvitationState(e,{chid:t,media_id:i},"rejected"),this.container.commonImpl.makeCallReject(e,i),this.clearData({type:e,chatid:t,id:i});var n=" reject trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,n)},i.prototype.__handleUIAccept=function(i,n,a){var o=this,r=this.container,e=this.container.commonImpl.getActiveCallData(),t=r.commonImpl.getCallStatusByChid(e),c=r.commonImpl.getCallStatusByChid(n);if(e&&e!=n)for(var s in t){var l=t[s].callStatus,d=t[s].id;"connected"==l?this.endOngoingCall(e):"ringing"!=l&&"connecting"!=l||(("upstream"==t[s].host?r.commonImpl.makeCallCancel.bind(r.commonImpl):r.commonImpl.makeCallReject.bind(r.commonImpl))(i,d),r.commonImpl.removeActiveCallData())}this.container.commonImpl.getCallStatusByChid(n)[a].mediarequest?this.container.MediaPermission.getScreenShareStream(function(){var e,t=r.commonImpl.getCallStatusByChid(n);t&&t[a]?(r.commonImpl.updateCallStatus(n,a,"connecting"),r.commonImpl.setActiveCallData(n),r.commonImpl.makeCallAccept(i,a),e={chid:n,media_id:a,muteCbk:function(){return o.toggleMute()},rejectCbk:function(){return"upstream"==c[a].host?o.container.commonImpl.makeCallCancel(i,a):o.container.commonImpl.makeCallReject(i,a)}},r.uiHandler.updateCallInvitationState(i,e,"connecting"),r.MediaPermission.screenEndFromBrowserUI(function(){return o.handleUIEnd({type:i,id:a,chatid:n})})):r.MediaPermission.closeStreamByType(i)},this.onMediaPermissionFailure(n,a)):this.container.commonImpl.makeCallAccept("screen_share",id),this.container.commonImpl.removeIncomingRequestData(n),this.container.commonImpl.setActiveTab()},i.prototype.handleUIAccept=function(e,t,i,n){var a=this,o=this.container.commonImpl.getActiveCallData();o&&o!=t?this.container.uiHandler.handleCallClash(function(){return a.__handleUIAccept(e,t,i,n)},function(){return a.handleUIReject(e,t,i)}):this.__handleUIAccept(e,t,i,n)},i.prototype.startScreenShare=function(e){try{var t,i=e.chatid,n=e.mediarequest,a=!0;if("visitor"==e.mode){var o=n?"view_screen":"share_screen";if(this.container.detailsHandler.checkIsSSOnGoing(i,o))return;if(this.container.detailsHandler.checkActiveScreenShare(i,e))return;a=this.isScreenShareAllowed(e,o)}else a=!0;a?n?this.initRequest(this.onMediaPermissionSuccess(e)):this.container.MediaPermission.getScreenShareStream(this.onMediaPermissionSuccess(e),this.onMediaPermissionFailure(i,e.id,!0)):(t="To start Siq Screen Share  - permission checks failed | chid - "+i+" ",this.callBackAction(this.implConstants.postDebugLog,t)),this.container.commonImpl.setActiveTab()}catch(e){}},i.prototype.initRequest=function(e){e()},i.prototype.onMediaPermissionSuccess=function(e){var t=this;e.mode=e.mode?e.mode:"visitor";var i=this.constructResponeObj(e),n=this.container.commonImpl.constructURL(null,null);return this.container.commonImpl.setActiveCallData(e.chatid),function(){t.container.ajaxHandler.post(n,i,t.onstarted.bind(t),t.startCallFailure.bind(t))}},i.prototype.onMediaPermissionFailure=function(i,n,a){var o=this;return void 0===a&&(a=!1),function(e,t){try{a||(o.container.commonImpl.makeCallReject("screen_share",n),o.container.uiHandler.updateCallInvitationState("screen_share",{chid:i,media_id:n},"rejected"))}catch(e){}}},i.prototype.constructResponeObj=function(e){return Object.assign({},{type:"screen_share"},e)},i.prototype.sendOffer=function(e){this.container.commonImpl.sendOffer(e)},i.prototype.sendAnswer=function(e){this.container.commonImpl.sendAnswer(e)},i.prototype.sendCandidate=function(e){this.container.commonImpl.sendCandidate(e)},i.prototype.onstarted=function(e){var t=this,i=JSON.parse(JSON.parse(e.msg||e.data.msg).media),n=this.container,a=i.chatid,o=i.id,r=i.type,c=i.mediaRequest,s={};s.chid=a,s.id=o,s.type=r,s.callType="outgoing",s.callStatus="ringing",s.mediarequest=c,s.host="upstream";n.dataHandler.set(o+"_waiting_timer",setTimeout(function(){n.commonImpl.makeCallMissed(r,o),t.clearData({type:r,chatid:a,id:o}),n.uiHandler.updateCallInvitationState(r,{chid:a,media_id:o},"missed")},6e4));var l=n.dataHandler.get(a+"_call_status",!0)||{};l[o]=s,n.dataHandler.set(a+"_call_status",l,!0);var d={chid:a,media_id:o,cancelCbk:function(){return t.handleUICancel(r,a,o)},muteCbk:function(){}};n.uiHandler.showScreenShareMaking(r,d),c||n.MediaPermission.screenEndFromBrowserUI(function(){return t.handleUIEnd({type:r,id:o,chatid:a})}),n.detailsHandler.triggerIconCheck(a)},i.prototype.startCallFailure=function(){},i.prototype.addRemoteStream=function(e,t){var i=this;try{var n=t.type,a=t.mid,o=t.chid,r=e.stream;e.streams&&(r=e.streams[0]),this.container.uiHandler.playScreenShareStream({stream:r,chid:o,mid:a,endCbk:function(){return i.handleUIEnd({type:n,id:a,chatid:o})}})}catch(e){}},i.prototype.clearData=function(e){try{var t=this.container,i=(e.type,e.chatid||e.chid),n=e.id||e.mid,a=t.commonImpl;this.container.detailsHandler.getCurrentUserId();this.closePeerConn(e),a.removeCredential(n),a.checkAVIcon(i),a.clearCallDetails(i,n),a.getActiveCallData()&&a.getActiveCallData()==i&&!a.getCallStatusByChid(i)&&t.commonImpl.removeActiveCallData(),a.removeIncomingRequestData(i),a.stopNotificationSound(),a.checkAndPlayNotification(),a.getCallStatusByChid(i)||a.removeActiveTab()}catch(e){}},i.prototype.closePeerConn=function(e){var t=e.chatid,i=e.type,n=e.id;try{var a=this.container.dataHandler.get(t+"_peer");if(!a)return void this.clearMediaPermision(i);a[n].closeConnection(),delete a[n],this.clearMediaPermision(i)}catch(e){}},i.prototype.clearMediaPermision=function(e){this.container.MediaPermission.closeStreamByType(e)},i.prototype.handleUIEnd=function(e){var t=e.type,i=e.id,n=e.chatid;this.container.commonImpl.makeCallEnd(t,i);this.container.dataHandler.get(n+"_peer");this.container.uiHandler.updateCallInvitationState(t,{chid:n,media_id:i},"ended"),this.container.detailsHandler.clearPlayer(),this.clearData({type:t,chatid:n,id:i})},i.prototype.callConnected=function(e){this.screenShareConnectedUI(e)},i.prototype.screenShareConnectedUI=function(e){var t=this,i=e.chid,n=e.type,a=e.mid,o=e.isUpStream,r=this.container,c=r.commonImpl.getCallStatusByChid(i)[a].mediarequest,s=this.container.commonImpl.getEligibleMediaAction(e.chid,n),l={chid:i,media_id:a};o&&c?l=Object.assign(l,{callEndCbk:function(){return t.handleUIEnd({chatid:e.chid,type:n,id:a})},muteCbk:function(){return function(){}},eligibleOption:s,isViewing:!0}):o&&!c||!o&&c?l=Object.assign(l,{callEndCbk:function(){return t.handleUIEnd({chatid:e.chid,type:n,id:a})},muteCbk:function(){return function(){}},eligibleOption:s,isViewing:!1}):o||c||(l=Object.assign(l,{callEndCbk:function(){return t.handleUIEnd({chatid:e.chid,type:n,id:a})},muteCbk:function(){return function(){}},eligibleOption:s,isViewing:!0})),this.container.commonImpl.updateCallStatus(i,a,"connected"),r.uiHandler.updateCallInvitationState("screen_share",l,"connected")},i.prototype.callBackAction=function(e,t){({postDebugLog:this.postDebugLog.bind(this)})[e](t)},i.prototype.init=function(){this.implConstants={postDebugLog:"postDebugLog"}},i.prototype.postDebugLog=function(e){this.container.detailsHandler.sendDebugLogger(e,null,null,!0)},i.prototype.handleUICancel=function(e,t,i){this.container.commonImpl.makeCallCancel(e,i),this.clearData({type:e,chatid:t,id:i});var n={chid:t,media_id:i,type:e};this.container.uiHandler.updateCallInvitationState("screen_share",n,"cancelled")},i.prototype.swapScreenShare=function(e,t){void 0===t&&(t={});var i=e.chatid,n=e.id,a=this.getScreenShareType(i,n);this.container.screenShareImpl.handleUIEnd({type:"screen_share",id:n,chatid:i}),this.container.commonImpl.removeActiveCallData();var o={chatid:i,mode:"visitor",type:"screen_share",mediainvitation:!0,mediarequest:!0};a&&(o.mediarequest=!1,o.mediainvitation=!1);var r=Object.assign({},o,t);this.container.screenShareImpl.startScreenShare(r)},i.prototype.getScreenShareType=function(e,t){var i=this.container.commonImpl.getCallStatusByChid(e);if(!i)return-1;var n=i[t];if(!n)return-1;var a=n.mediarequest,o="upstream"==n.host;return o&&a?1:o&&!a||!o&&a?0:o||a?void 0:1},i.prototype.endOngoingCall=function(e,t){var i=this.container,n=i.dataHandler.get(e+"_peer");if(n)for(var a in n){var o=n[a];this.container.uiHandler.updateCallInvitationState(o.type,{chid:e,media_id:o.mid},"ended"),this.container.commonImpl.makeCallEnd(o.type,o.mid),this.clearData(o),delete n[a]}else{var r="screen_share";this.container.commonImpl.makeCallEnd(r,t),this.clearData({type:r,chatid:e,id:t})}i.commonImpl.removeActiveCallData(e)},i.prototype.isScreenShareSupported=function(){};function n(e){((this.container=e).commonImpl=this).reloadCheck=!1}n.prototype.setCredential=function(e){var t=e.id,i=e.type,n={mid:t,credential:e.credentials,chid:e.chatid,type:i};this.container.dataHandler.set(t+"_credential",n)},n.prototype.removeCredential=function(e){this.container.dataHandler.remove(e+"_credential")},n.prototype.constructURL=function(e,t){var i="media";return e&&(i+="/"+t+"/"+e),i},n.prototype.sendOffer=function(e){var t=this.constructURL("offer",e.mid),i={};i.session=this.container.detailsHandler.toJSON(e.description),this.container.ajaxHandler.post(t,i,null,null)},n.prototype.sendAnswer=function(e){var t=this.constructURL("answer",e.mid),i={};i.session=this.container.detailsHandler.toJSON(e.description),this.container.ajaxHandler.post(t,i,null,null)},n.prototype.sendCandidate=function(e){var t=this.constructURL("candidates",e.mid),i={};i.candidates=e.candidates,this.container.ajaxHandler.post(t,i,null,null)},n.prototype.setActiveCallData=function(e){this.container.dataHandler.set("active_call",e,!0)},n.prototype.getActiveCallData=function(){return this.container.dataHandler.get("active_call",!0)},n.prototype.removeActiveCallData=function(){this.container.dataHandler.remove("active_call",!0)},n.prototype.setCallStatus=function(e,t,i,n,a,o,r,c){void 0===c&&(c=!1);var s={chid:e,id:t,type:i,callType:n,callStatus:a,mediarequest:o,host:r,isdirectcall:c},l=this.getCallStatusByChid(e)||{};l[t]=s,this.container.dataHandler.set(e+"_call_status",l,!0)},n.prototype.getCallStatusByChid=function(e){return this.container.dataHandler.get(e+"_call_status",!0)},n.prototype.getAcitveMediaTypes=function(){var e=this.container.dataHandler.get("active_call",!0),t=this.getCallStatusByChid(e);return t?Object.values(t).map(function(e){return e.type}):[]},n.prototype.updateCallStatus=function(e,t,i){var n=this.container.dataHandler.get(e+"_call_status",!0);n&&n[t]&&(n[t].callStatus=i),this.container.dataHandler.set(e+"_call_status",n,!0)},n.prototype.checkAVIcon=function(e){this.container.dataHandler.get("active_call",!0)==e&&this.container.uiHandler.enableOutingCallUI()},n.prototype.checkNetwork=function(t,i,e){var n=this;void 0===e&&(e=!1);var a=this.container.dataHandler.get(t+"_peer")[i],o=a.type;a.reconnectInterval=setTimeout(function(){var e=document.createElement("IMG");e.src=_MEDIASERVERURL+"/images/spacer.gif?nocache="+(new Date).getTime(),e.onload=function(){a.iceRestart=!0,a.isUpStream&&a.createOffer(),n.updateAcceptedTimeForMediaStats(Date.now(),i)},e.onerror=function(){return n.checkNetwork(t,i,!0)}},5e3),a.reconnectEndTimer||(a.reconnectEndTimer=setTimeout(function(){n.container[o+"Impl"].endOngoingCall(t),clearTimeout(a.reconnectInterval),a.reconnectEndTimer=null},3e4)),e||this.container.uiHandler.updateCallInvitationState(o,{chid:t,media_id:i},"reconnecting")},n.prototype.clearNetworkTimer=function(e){clearTimeout(e.reconnectEndTimer),clearTimeout(e.reconnectInterval)},n.prototype.clearCallDetails=function(e,t){var i=this.container.dataHandler.get(e+"_call_status",!0);delete i[t],0<Object.keys(i).length?this.container.dataHandler.set(e+"_call_status",i,!0):this.container.dataHandler.remove(e+"_call_status",!0),this.container.dataHandler.remove(t+"_credential")},n.prototype.updateCommonData=function(){},n.prototype.getCommonData=function(){},n.prototype.makeCallMissed=function(e,t,i){this.makeCallHelper("miss",e,t,i)},n.prototype.makeCallAccept=function(e,t,i){this.makeCallHelper("accept",e,t,i)},n.prototype.makeCallCancel=function(e,t,i){this.makeCallHelper("cancel",e,t,i)},n.prototype.makeCallEnd=function(e,t,i){this.makeCallHelper("end",e,t,i)},n.prototype.makeCallReject=function(e,t,i){this.makeCallHelper("reject",e,t,i)},n.prototype.makeCallConnected=function(e){var t=this.constructURL("connected",e.mediaid),i={latency:e.latency,reconcount:e.reconcount,callerType:e.callerType,lsid:e.lsid};e.wmsid&&(i.wmsid=e.wmsid),this.container.ajaxHandler.post(t,i,null,null)},n.prototype.makeCallHelper=function(e,t,i,n){var a=this.container,o=a.commonImpl.constructURL(e,i);a.ajaxHandler.post(o,{},n)},n.prototype.updateIncomingRequestData=function(e){var t={},i=e.chatid,n=e.type,a=e.id,o=this.container,r=o.dataHandler.get("media_inv")||[];t[i]={type:n,id:a},r.push(t),o.dataHandler.set("media_inv",r,!0)},n.prototype.removeIncomingRequestData=function(e){var t=this.container,i=t.dataHandler.get("media_inv",!0);for(var n in i){var a=i[n];Object.keys(a)[0]==e&&i.splice(n,1)}i&&(0==i.length?this.deleteIncomingRequestKey():t.dataHandler.set("media_inv",i,!0))},n.prototype.getIncomingRequest=function(){return this.container.dataHandler.get("media_inv",!0)},n.prototype.deleteIncomingRequestKey=function(){this.container.dataHandler.remove("media_inv",!0)},n.prototype.getMediaDataByChidAndType=function(e){var t=e.chatid,i=e.type,n=this.getCallStatusByChid(t);for(var a in n){var o=n[a];if(o.type==i)return o}return null},n.prototype.endCallByChid=function(s,l){var d=this;try{var u=this.getCallStatusByChid(s),p=this.container;for(var e in u)!function(e){var t=u[e],i=t.id,n=t.type,a=t.callStatus,o=t.isdirectcall,r=d.container[n+"Impl"],c={chid:s,media_id:i,type:n};"connected"==a?(r.endOngoingCall(s,i,l||function(){return o&&p.detailsHandler.endSession(s)}),p.uiHandler.updateCallInvitationState(n,c,"ended")):"connected"!=a&&"incoming"==t.callType?(o||p.commonImpl.makeCallReject(n,i,l),p.uiHandler.updateCallInvitationState(n,c,"rejected"),o&&r.handleUIApiReject(n,s,i)):"connected"!=a&&"outgoing"==t.callType&&(clearTimeout(p.dataHandler.get(i+"_waiting_timer")),p.commonImpl.makeCallCancel(n,i,l),p.uiHandler.updateCallInvitationState(n,c,"cancelled")),c.id=i,r.clearData(c)}(e)}catch(e){}},n.prototype.checkOnGoingCall=function(){try{this.checkAndClearDataOnRefresh()}catch(e){}},n.prototype.checkAndClearDataOnRefresh=function(){var t=this;Object.keys(localStorage).forEach(function(e){return e.match(/SiqMedia_/g)&&t.container.dataHandler.remove(e.replace("SiqMedia_",""),!0)})},n.prototype.setActiveTab=function(){this.container.dataHandler.set("media_active",!0)},n.prototype.getActiveTab=function(){return this.container.dataHandler.get("media_active")||!1},n.prototype.removeActiveTab=function(){this.container.dataHandler.remove("media_active")},n.prototype.currentUserBrowserSupportSS=function(){var e=this.container.MediaDetails.getPlatform();return!!/linux|Microsoft Windows|Mac OS|MacIntel|Win32|Win64/i.test(e)&&this.container.MediaDetails.checkBrowserSupported()},n.prototype.checkIncomingCallAllowed=function(e){var t=e.chatid,i=(e.id,e.type);if(this.getMediaDataByChidAndType({chatid:t,type:i}))for(var n=this.container.dataHandler.get(t+"_peer"),a=n&&Object.keys(n).length||0,o=0;o<a;o++){return"connected"!=n[Object.keys(n)[o]].connectionStatus?(this.endCallByChid(t),!1):!0}return!1},n.prototype.setMediaStatsDetail=function(e){var t=e.acceptedTime,i=e.type,n=e.mediaid,a={acceptedTime:t,type:i,mediaid:n,reconnectCount:e.reconnectCount,lsid:e.lsid,callerType:e.callerType};this.container.dataHandler.set(n+"_connectionstats",a)},n.prototype.updateMediaStatsDetail=function(e){var t=e.connectedTime,i=e.isreconnected,n=e.mediaid,a=this.container.dataHandler.get(n+"_connectionstats");a.connectedTime=t,a.reconnectCount=i?a.reconnectCount+1:a.reconnectCount,this.container.dataHandler.set(n+"_connectionstats",a)},n.prototype.updateAcceptedTimeForMediaStats=function(e,t){var i=this.container.dataHandler.get(t+"_connectionstats");i.acceptedTime=e,this.container.dataHandler.set(t+"_connectionstats",i)},n.prototype.getConnectedStatsDetail=function(e){var t=this.container.dataHandler.get(e+"_connectionstats"),i={latency:t.connectedTime-t.acceptedTime,reconcount:t.reconnectCount,callerType:t.callerType,lsid:t.lsid,mediaid:e};return this.container.detailsHandler.isEmbed()&&(i.wmsid=this.container.detailsHandler.getVisitorWMSID()),i},n.prototype.clearConnectedStatsDetail=function(e){this.container.dataHandler.remove(e+"_connectionstats")};var a=function(e){function t(){e.apply(this,arguments),this.isDirectCallAllowed=!1}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.audioIconStatus=function(e,t,i){void 0===i&&(i=1);var n=this.container.detailsHandler,a=this.container.commonImpl.getMediaDataByChidAndType({chatid:e,type:"audio"})||!1,o={not_group_chat:!n.isGroupConversation(e),not_bot:!n.isAttenderBot(e),ongoing_chat:n.isChatExist(e),audiocall_enabled:n.isAudioCallEnabled(),current_plan_allowed:n.isPlanAllowed(),is_secure:n.isSecureConnection(),is_proactive_chat:!n.isProactiveChat(e),live_chat_window:n.isliveChatWindow(),isFacebookIntegration:!n.isFaceBookIntegration()},r={ongoing_call_current_chat:a,incoming_call_notification:n.hasIncomingCall(e)},c={1:["not_group_chat","not_bot","ongoing_chat","audiocall_enabled","current_plan_allowed","is_secure","is_proactive_chat","live_chat_window","isFacebookIntegration"]}[i].map(function(e){return o[e]}).reduce(function(e,t){return e&&t},!0),s={1:["ongoing_call_current_chat","incoming_call_notification"]}[i].map(function(e){return r[e]}).reduce(function(e,t){return e||t},!1);t(e,c?s?"disable":"show":"hide")},t.prototype.onstarted=function(e){var t=this;if(e.data.error&&"5001"==e.data.error.code){e.data.error.code;return this.container.commonImpl.removeActiveTab(),this.container.commonImpl.removeActiveCallData(),this.container.MediaPermission.closeAllStream(),this.container.detailsHandler.hideAudioCall(),this.container.detailsHandler.stopNotifSound(),!0}var i=JSON.parse(JSON.parse(e.data.msg).media),n=this.container,a=i.chatid,o=i.id,r=i.type,c=i.mediaRequest;this.iconClicked={};n.dataHandler.set(o+"_waiting_timer",setTimeout(function(){n.commonImpl.makeCallMissed(r,o),t.clearData({type:r,chatid:a,id:o}),n.uiHandler.updateCallInvitationState(r,{chid:a,media_id:o},"missed")},6e4)),n.commonImpl.setCallStatus(a,o,r,"outgoing","ringing",c,"upstream"),n.commonImpl.setActiveCallData(a);var s={chid:a,media_id:o,cancelCbk:function(){n.commonImpl.makeCallCancel(r,o),n.uiHandler.updateCallInvitationState("audio",{chid:a,media_id:o},"cancelled"),t.clearData({type:r,chatid:a,id:o})},muteCbk:function(){return t.toggleMute()}};n.uiHandler.handleAudioCallInitiate(r,s),n.detailsHandler.triggerIconCheck(a)},t.prototype.startApiDirectCall=function(e){var t=this,i=(e.conversationType,e.successCbk),n=this.container,a=function(){clearTimeout(o)},o=setTimeout(function(){a=n.uiHandler.mediaPermissionUI()},3e3);return n.MediaPermission.getAudioStream(function(){a(),t.directCallMediaPermissionSuccess(i)},function(){return t.directCallMediaPermissionFailure(function(){return a()})}),this.container.commonImpl.setActiveTab(),this.isDirectCallAllowed=!0},t.prototype.directCallMediaPermissionSuccess=function(e){var t=this;try{this.container.detailsHandler.playNotifSound({tone:"outgoingcall",duration:60}),this.isDirectCallAllowed=!0;e(function(){return t.toggleMute()})}catch(e){}},t.prototype.directCallMediaPermissionFailure=function(e){return e(),this.container.uiHandler.mediaPermissionUnlock(),this.container.uiHandler.directCallCancelled(),!1},t.prototype.handleUIApiReject=function(e,t,i){this.handleUIReject(e,t,i),this.container.detailsHandler.initMissedChat(chatid,"CALLENDED","2",!0)},t.prototype.handleUIApiCallEnd=function(e,t,i){var n=this;this.container.commonImpl.makeCallEnd(t,i,function(){return n.container.detailsHandler.endSession(e)}),this.handleCallEnd({chatid:e,type:t,id:i}),localStorage.removeItem("siq_directcall")},t.prototype.onDirectCallStarted=function(e){var t=this,i=this.container,n=e.type,a=e.id,o=e.chatid,r=e.mediaRequest;i.commonImpl.setCredential(e);i.dataHandler.set(a+"_waiting_timer",setTimeout(function(){i.commonImpl.makeCallMissed(n,a),t.clearData({type:n,chatid:o,id:a}),i.detailsHandler.initMissedChat(o,"CALLENDED","2",!0),i.uiHandler.updateCallInvitationState(n,{chid:o,media_id:a},"missed")},6e4)),i.commonImpl.setCallStatus(o,a,n,"outgoing","ringing",r,"upstream",!0),i.commonImpl.setActiveCallData(o);function c(){i.commonImpl.makeCallCancel(n,a,function(){return i.detailsHandler.initMissedChat(o,"CALLENDED","2",!0)}),i.uiHandler.updateCallInvitationState("audio",{chid:o,media_id:a},"cancelled"),localStorage.removeItem("siq_directcall"),t.clearData({type:n,chatid:o,id:a})}function s(){return t.toggleMute()}i.detailsHandler.triggerIconCheck(o);setTimeout(function(){return i.uiHandler.handleAudioCallInitiate(n,{chid:o,cancelCbk:c,muteCbk:s,media_id:a,isDirectCall:!0})},500),clearTimeout(i.detailsHandler.getChatWinObjById(o).waitTimer),localStorage.setItem("siq_directcall",JSON.stringify({chid:o,media_id:a,type:n,status:"outgoing"}))},t.prototype.startAudioCallAgain=function(e){var t,i;this.hasIncommingCall(e)||(i={type:"audio",chatid:(t=this.container.detailsHandler.getChatWinObjById(e)).chatID,mode:"visitor",mediarequest:!0,mediainvitation:!0,wmsid:$Support.EmbedObj.vwmsid,lsuid:t.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid},SiqAVRouter.container.audioImpl.startAudioCall(i))},t.prototype.pushVoiceToServer=function(e){var t={},i=$Support.getAjaxURL("makeav",dext),n=this.container.detailsHandler.getChatWinObjById(e);t.action="voicerec",t.wmsid=$Support.EmbedObj.vwmsid,t.chid=n.chatID,t.cuid=n.visitorID,t.lsuid=n.attender,$.ajax({url:i,data:t,type:"POST"})},t}(e),r=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.screenshareIconStatus=function(e){var t=e.chid,i=e.callback,n=e.type;void 0===n&&(n=1);var a=this.container.detailsHandler,o={not_group_chat:!a.isGroupConversation(t),not_bot:!a.isAttenderBot(t),ongoing_chat:a.isChatExist(),audiocall_enabled:a.isScreenShareAllowed(t),current_plan_allowed:a.isPlanAllowed()},r={sharescreenAllowed:!a.isShareScreenAllowed(t)},c={1:["not_group_chat","not_bot","ongoing_chat","audiocall_enabled","current_plan_allowed"]}[n].map(function(e){return o[e]}).reduce(function(e,t){return e&&t},!0),s={1:["sharescreenAllowed"]}[n].map(function(e){return r[e]}).reduce(function(e,t){return e&&t},!0);"function"==typeof i&&i(t,c?s?"disable":"show":"hide")},t.prototype.isScreenShareAllowed=function(e){var t=this.container,i=e.chatid,n=!0,a="",o="";return!t.commonImpl.getMediaDataByChidAndType({chatid:i,type:t.constants.screen_share})&&(t.detailsHandler.isSecureConnection()?t.detailsHandler.isShareScreenAllowed(i)||(n=!1,o="siqMedia: screen share Failed screen share not allowed | chid - "+i):(n=!1,a=t.detailsHandler.I18N("av.info.insecuredwebsite"),o="siqMedia: screen share Failed Visitor not in secure connection | chid - "+i),!n&&a&&(t.uiHandler.showDialog({desc:a,buttons:{accept:{text:"common.ok",callback:function(){return null}}}}),callBackAction(implConstants.postDebugLog,o)),n)},t}(i),c=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t}(t),s=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.checkAndUpdateUIForApi=function(){},t.prototype.playMediaNotificationSound=function(e){this.container.detailsHandler.playNotifSound(e)},t.prototype.stopNotificationSound=function(){this.container.detailsHandler.stopNotifSound()},t.prototype.showDesktopNotif=function(){},t.prototype.startApiCall=function(e){var t=e.conversationtype,i=this.container.constants[t]+"Impl";return this.container[i].startApiDirectCall(e)},t.prototype.getEligibleMediaAction=function(e){var t=this.container,i=this.container.constants,n=t.detailsHandler.isAudioCallEnabled(),a=(t.detailsHandler.isScreenShareEnabled(),t.commonImpl.getCallStatusByChid(e)),o=new Array;n&&o.push(i.audio),o.push(i.screen_share),o.push(i.video);for(var r in a)!function(e){var t=a[e];o=o.filter(function(e){return![t.type].includes(e)})}(r);return o},t.prototype.checkAndPlayNotification=function(){},t.prototype.getEligibleMediaAction=function(e){var t=this.container,i=this.container.constants,n=t.detailsHandler.isAudioCallEnabled(),a=(t.detailsHandler.isScreenShareEnabled(),t.commonImpl.getCallStatusByChid(e)),o=new Array;n&&o.push(i.audio),o.push(i.screen_share),o.push(i.video);for(var r in a)!function(e){var t=a[e];o=o.filter(function(e){return![t.type].includes(e)})}(r);return o},t.prototype.getFailureMessage=function(e){var t=null;switch(e.name){case"NotFoundError":case"DevicesNotFoundError":t=LSResource.getRealValue("av.info.microphone.notavailable");break;case"SourceUnavailableError":case"PermissionDeniedError":case"SecurityError":case"NotAllowedError":default:t=LSResource.getRealValue("av.info.microphone.blocked")}return t},t.prototype.sendMediaStats=function(e,t){var i=e.msg,n=((i?i.media:null)||e).id,a={};e.statcode&&(a.statcode=e.statcode),a.description=t;var o="stats/"+n+"/media";this.container.ajaxHandler.post(o,a,null,null)},t}(n);function v(e,t){for(var i=[],n=arguments.length-2;0<n--;)i[n]=arguments[n+2];return{tag:e,props:t||{},children:i}}function m(e,t){if(void 0===t&&(t={}),-1!=["number","string","undefined"].indexOf(typeof e))return document.createTextNode(e);var i=document.createElement(e.tag);p(i,e.props,t);for(var n=0;n<e.children.length;n++)i.appendChild(m(e.children[n],t));return i}function p(e,t,i){if(!e.skipattr)for(var n in t)"skipattr"==n?e.skipattr=!0:"on"==n.slice(0,2)?function(e,t,i){t=t.slice(2).toLowerCase(),e._listeners&&e._listeners[t]||e.addEventListener(t,function(e){return this._listeners[e.type](e)},!1);(e._listeners||(e._listeners={}))[t]=i}(e,n,t[n]):"ref"===n.slice(0,3)?i.refs[t[n]]=e:"html"===n.slice(0,4)?e.innerHTML=t[n]:"video"!=e.tagName.toLowerCase()||e[n]?n&&void 0!==t[n]&&$(e).attr(n)!=t[n]&&e.setAttribute(n,t[n]):e[n]=t[n]}Element.prototype.zsiqdrag=function(e,s){var l=0,d=0,u=this,p=!1;function h(e){var t=getComputedStyle(u),i=parseInt(t.getPropertyValue("left"))||0,n=parseInt(t.getPropertyValue("top"))||0;if(i<0||n<0)return i<0&&(u.style.left="0px"),n<0&&(u.style.top="0px"),p=!1,void(s?window.parent:window).removeEventListener("mousemove",h);var a=parseInt(t.getPropertyValue("right"))||0,o=parseInt(t.getPropertyValue("bottom"))||0;if(a<0||o<0){var r=e.pageX-l,c=e.pageY-d;return u.style.left=r-10+"px",u.style.top=c-10+"px",p=!1,void(s?window.parent:window).removeEventListener("mousemove",h)}u.style.left=e.pageX-l+"px",u.style.top=e.pageY-d+"px"}this.addEventListener("mousedown",function(e){p=!0;var t=getComputedStyle(u),i=parseInt(t.getPropertyValue("left"))||0,n=parseInt(t.getPropertyValue("top"))||0;l=e.pageX-i,d=e.pageY-n,(s?window.parent:window).addEventListener("mousemove",h)}),this.addEventListener("mouseup",function(e){!0===p&&(p=!1,(s?window.parent:window).removeEventListener("mousemove",h))})};function o(){this.embed=SiqAVRouter.container.detailsHandler.isEmbed(),this.reRender()}o.prototype.updateState=function(e){e&&(this.state=e);try{this.reRender()}catch(e){}},o.prototype.reRender=function(){var e;this.dom&&1==this.dom.nodeType?this.dom=function e(t,i,n,a){var o,r,c,s=t;if(t)if(o=t,(c=-1!=["string","number"].indexOf(typeof(r=i)))||3==o.nodeType?c&&3==o.nodeType&&o.textContent==r:o.tagName.toLowerCase()==r.tag.toLowerCase()){if("object"==typeof i&&1==t.nodeType){var l=Math.max(t.childNodes.length,i.children.length),d=Array.from(t.childNodes);p(t,i.props||{},a);for(var u=0;u<l;u++)e(d[u],i.children[u]?i.children[u]:"",t,a)}}else s=m(i,a),$(t).replaceWith(s);else i&&n.append(m(i,a));return s}(this.dom,this.render(),this.placeholder,this):(e=m(this.render(),this),this.dom&&$(this.dom).replaceWith(e),this.dom=e,this.embed?!this.disableDrag&&e.zsiqdrag&&e.zsiqdrag(e,this.frameout):this.disableDrag||1!=e.nodeType||$(e).draggable({containment:"window",scroll:!1})),this.dom&&!this.dom.parentNode&&(this.placeholder_prepend?$(this.placeholder).prepend(this.dom):$(this.placeholder).append(this.dom))},o.prototype.destroy=function(){$(this.dom).remove()};var l=function(n){function e(e,t,i){this.state=e,this.placeholder=t,this.refs={},this.container=i,this.screenShareAllowed=i.detailsHandler.isScreenShareAllowed(),n.call(this)}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.destroy=function(){this.ssTimer&&clearInterval(this.ssTimer),this.audioTimer&&clearInterval(this.audioTimer),$(this.dom).remove()},e.prototype.canStartSS=function(){return!this.state.screen_share},e.prototype.getUI=function(){var e=this.state,t=e.audio,i=e.screen_share;return!i||"sharing"!=i.type||t&&"connected"!=t.status?t&&(!i||"viewing"!=i.type||"viewing"==i.type&&"connected"!=t.status)?this.getAudioCallUI():"":this.getScreenShareUI()},e.prototype.getAudioCallBtns=function(){var e=this,t=this.state,i=t.handler,n=(t.name,t.url,t.screen_share),a=t.audio,o=t.chid,r=a.mute,c=a.status,s=this.container.detailsHandler,l="invited"==c,d="connected"==c,u="requested"==c,p="connecting"==c,h=s.isScreenShareAllowed()&&s.isShareScreenAllowed(o),m=n&&("connected"==n.status?"end":"cancel"),g="connected"==c?"end":"cancel";return v("div",{class:"cal_actns"},h&&!n&&d?v("div",{title:C("screenshare"),class:"sqico-screenshare",onclick:function(){return e.container.uiHandler.shareScreen(o)}}):"",n&&"sharing"==n.type?v("div",{title:C(m),class:"sqico-ssend",onclick:function(){return i(o,"screen_share","reject")}}):"",d||u||p?v("div",{title:C(r?"unmute":"mute"),id:"audiocall_mute",class:"sqico-"+(r?"muteaudio":"microphone"),onClick:function(){return i(o,"audio","mute")}}):"",l?v("div",{title:C("accept"),class:"sqico-call",onclick:function(){return i(o,"audio","accept")}}):"",v("div",{title:C(g),class:"sqico-call reject-cal",ref:"audio_call_reject",onclick:function(){return i(o,"audio","reject")}}))},e.prototype.getScreenShareBtns=function(){var e=this.state,t=e.handler,i=e.screen_share,n=e.audio,a=e.chid,o=i&&("connected"==i.status?"end":"cancel"),r=n&&("connected"==n.status?"end":"cancel");return v("div",{class:"cal_actns"},v("div",{title:C(o),class:"sqico-ssend",onclick:function(){return t(a,"screen_share","reject")}}),n&&"connected"==n.status?v("div",{title:C(n.mute?"unmute":"mute"),id:"audiocall_mute",class:"sqico-"+(n.mute?"muteaudio":"microphone"),onClick:function(){return t(a,"audio","mute")}}):"",n&&"connected"==n.status?v("div",{title:C(r),class:"sqico-call reject-cal",ref:"audio_call_reject",onclick:function(){return t(a,"audio","reject")}}):"")},e.prototype.getAudioCallUI=function(){var e=this.state,t=(e.handler,e.name),i=e.url,n=(e.screen_share,e.audio),a=e.chid,o=(n.mute,n.status),r="invited"==o,c="requested"==o,s=i&&i(n.media_id)?v("img",{src:i(n.media_id,a),draggable:"false"}):v("em",{class:"sqico-person"});return v("div",{class:"zsembd_audiocl textC"},v("nav",{class:"zsembd_usrprof "+(r||c?"zsembd_calrng":"")},v("div",{class:" sqico-personimg"}," ",s," ")),v("span",{class:"zsembd_adodesc txtelips"},t(a),v("em",{class:"txtelips font14",ref:"audio_call_info"}," ",this.getAudioCallStatusText()," ")),this.getAudioCallBtns())},e.prototype.getAudioCallStatusText=function(){var e=this.state.audio,t=e.status,i=e.timer;return{timer:i,connected:LSResource.getRealValue("common.connected"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting")}[i?"timer":t]||""},e.prototype.getScreenShareUI=function(){var e=this.state,t=(e.handler,e.name),i=e.url,n=e.screen_share,a=(e.audio,e.chid),o=n.status,r=i&&i(n.media_id)?v("img",{src:i(n.media_id,a),draggable:"false"}):v("em",{class:"sqico-person"});return v("div",{class:"zsembd_audiocl textC"},v("nav",{class:"zsembd_usrprof "+("invited"==o?"zsembd_calrng":"")},v("div",{class:" sqico-personimg"}," ",r," ")),v("span",{class:"zsembd_adodesc txtelips"},t(a),v("em",{class:"txtelips font14",ref:"audio_call_info"}," ",this.getSecreenShareStatusText()," ")),this.getScreenShareBtns())},e.prototype.getSecreenShareStatusText=function(){var e=this.state.screen_share,t=e.status;e.timer;return{connected:LSResource.getRealValue("ss.info.viewing"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting")}[t]||""},e.prototype.render=function(){return this.state.isDirectCall?"":this.getUI()},e}(o);function d(e,t,i){void 0===i&&(i=!0);var n={type:"audio",mode:"visitor",mediarequest:!0,mediainvitation:!0},a=e.detailsHandler.getChatWinObjById(t);i?$.extend(n,{chatid:a.chatID,wmsid:$Support.EmbedObj.vwmsid,lsuid:a.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid}):$.extend(n,{chatid:t}),e.audioImpl.startAudioCall(n)}var u=function(n){function e(e,t,i){this.state=e,this.placeholder=t,this.refs={},this.container=i,this.init(),n.call(this)}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.init=function(){this.fullscreen=!1,this.showcntrl=!1,this.frameout=!0,this.switchCbk=this.switchFullscreen.bind(this)},e.prototype.switchFullscreen=function(){this.fullscreen=!this.fullscreen,this.fullscreen?window.addEventListener("keyup",this.switchCbk):window.removeEventListener("keyup",this.switchCbk),this.reRender()},e.prototype.getAudioCallStatusText=function(){var e=this.state.audio,t=e.status,i=e.timer;return{timer:i,connected:LSResource.getRealValue("common.connected"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting")}[i?"timer":t]||""},e.prototype.getAudioCallBox=function(){var e=this.state,t=e.audio,i=e.handler,n=e.chid,a=e.name,o=e.url,r=this.embed?"siqico":"sqico",c=t&&("connected"==t.status?"end":"cancel");return v("div",{class:"zsiq_calldtl"},v("span",null,o&&o(t.media_id)?v("img",{src:o(t.media_id,n),class:"siquserimg"}):v("em",{class:r+"-user"}),v("em",{class:"zsiq_caller txtelips"},a(n))),v("span",null,this.getAudioCallStatusText(),t&&"connected"==t.status?v("em",{title:C(t.mute?"unmute":"mute"),class:r+"-"+(t.mute?"unmute":"mute")+" zsiq_ctrlico",onClick:function(){return i(n,"audio","mute")},"data-type":"mic"}):"",t&&"invited"==t.status?v("em",{title:C("accept"),class:r+"-end zsiq_vend zsiq_ctrlico zsiq_callin",onclick:function(){return i(n,"audio","accept")}}):"",v("em",{title:C(c),class:r+"-end zsiq_vend zsiq_ctrlico",onclick:function(){return i(n,"audio","reject")}}),v("em",null)))},e.prototype.showCntrl=function(){var e=this;this.showcntrl=!0,clearTimeout(this.showCntrlTimer),this.showCntrlTimer=setTimeout(function(){e.showcntrl=!1,e.reRender()},1500),this.reRender()},e.prototype.__swapHandlerClickCbk=function(){this.swapOptions&&($(this.swapOptions).remove(),this.swapOptions=null)},e.prototype.__swapHandler=function(e,n,t){function a(){return o.__swapHandlerClickCbk.call(o)}function i(e,t,i){n(e,t,i),a()}var o=this;if(this.swapOptions)return a();this.swapOptions=m(v("div",{class:"zsiqcalloptions",id:"calloptions",style:"left:"+(e.clientX-220)+";top:"+(e.clientY-65)+";height:65px;z-index:11111111111;"},v("div",{onClick:function(){return i(t,"screen_share","swap")}},"Screen my share"),v("div",{onClick:function(){return i(t,"screen_share","reject")}},"End screen share"))),this.placeholder.append(this.swapOptions)},e.prototype._SwapList=function(e,t,i){this.embed&&this.state.audio&&!this.fullscreen?this.__swapHandler(e,t,i):t(i,"screen_share","swap")},e.prototype.__callCbk=function(){d(this.container,this.state.chid,this.embed)},e.prototype.getScreenShareButtons=function(){var t=this,e=this.state,i=e.screen_share,n=e.audio,a=e.handler,o=e.chid,r=e.chatWinFocused,c=i.status,s=this.embed?"siqico":"sqico",l=i&&("connected"==i.status?"end":"cancel"),d=n&&("connected"==n.status?"end":"cancel");return v("div",{class:"zsiq_vctrl zsiq_center"},"connected"==c?v("em",{title:C("swap"),class:s+"-swap zsiq_ctrlico",onClick:function(e){return t._SwapList(e,a,o)}}):"",this.embed&&!this.fullscreen&&n&&"connected"==n.status?v("em",{title:C(n.mute?"unmute":"mute"),class:s+"-"+(n.mute?"unmute":"mute")+" zsiq_ctrlico",onClick:function(){return a(o,"audio","mute")},"data-type":"mic"}):"",!this.embed&&!this.fullscreen&&r||this.state.audio?"":v("em",{title:C("call"),class:s+"-call zsiqpickup zsiq_ctrlico",onclick:this.__callCbk.bind(this)}),this.embed&&!this.fullscreen&&n?v("em",{title:C(d),class:s+"-end zsiq_vend  zsiq_ctrlico",onclick:function(){return a(o,"audio","reject")}}):"",!this.fullscreen&&n&&this.embed?"":v("em",{title:C(l),class:s+"-ssend zsiq_vchat zsiq_ctrlico",onclick:function(){return a(o,"screen_share","reject")}}))},e.prototype.getUI=function(){var e=this.state,t=e.screen_share,i=e.audio,n=t.stream,a=t.timer,o=this.embed?"siqico":"sqico";return v("div",{class:"zsiq_video_main "+(this.fullscreen?"zsiq_maxvideo":"")+" "+(this.showcntrl?"zsiq_showcntl":""),onMouseMove:this.showCntrl.bind(this),onMouseDown:this.__swapHandlerClickCbk.bind(this)},v("em",{class:o+"-maxicon zsiq_maxicon zsiq_center",onclick:this.switchFullscreen.bind(this)}),v("span",{class:"zsiq_vtime",id:"zsiqvideo_time"},a),this.getScreenShareButtons(),v("video",{autoplay:!0,srcObject:n,className:"zsiq_video",id:"zsiqvideoviewer"}),this.fullscreen&&i?this.getAudioCallBox():"")},e.prototype.render=function(){var e=this.state.screen_share;return e&&"viewing"==e.type&&"requested"!=e.status?this.getUI():""},e}(o);function g(){var e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t={Chrome:"https://support.google.com/chrome/answer/2693767?hl=en",Firefox:"https://support.mozilla.org/en-US/questions/1168156",Opera:"https://help.opera.com/en/latest/web-preferences/#microphone",Safari:"https://support.apple.com/en-in/guide/safari/websites-ibrwe2159f50/mac"};t[e]&&window.open(t[e],"_blank")}function f(e,t,i,n,a){function o(){return $(s).remove()}function r(){var e=Recorder();a||(o(),$("body").append($Temp.getAudioRecordedUI(i(0,t),n(t)))),e.init(a,t)}var c,s;s=a?m(v("div",{class:"cal-wrap",id:"audiorec"},v("div",{class:"posrel dib-mid"},v("div",{class:"cal-widgt theme1 outcal"},v("div",{class:"posrel usr-imginfo"},v("div",{class:"cal-visimg "+((c=$Support.EmbedObj.clogo)?"":"sqico-user")},c?v("img",{src:c}):"")),v("div",{class:"cal-vstrdetl"},v("nav",{class:"cal-actvevstr elips font18"},LSResource.getRealValue("av.info.oprbusy")),v("p",{class:"cal-usrdesc elips"},LSResource.getRealValue("av.info.voicemsg"))),v("div",{class:"cal-optns posrel textR"},v("span",{onclick:r,class:"sqico-record bg-aaa"})))))):m(v("div",{class:"zsembd_audiocl textC",id:"call_Busy"},v("em",{class:"sqico-close",onClick:o}),v("nav",{class:"zsembd_usrprof"},v("div",{class:"'+perscls+' sqico-personimg"},v("div",{class:"cal-visimg "},v("img",{src:i&&i(0,t)})))),v("span",{class:"zsembd_adodesc txtelips"},n(t),v("em",{class:"txtelips font14"},LSResource.getRealValue("av.info.userbusy"))),v("div",{class:"cal_actns"},v("div",{class:"call-record",title:LSResource.getRealValue("av.info.voicemessage"),onclick:r}),v("div",{class:"sqico-call",title:LSResource.getRealValue("av.info.callagain"),onclick:function(){return o()&&d(e,t)}})))),a?(CallImpl.isCallWithChat=!0,$("body").prepend(s)):(s.zsiqdrag(),$("body").append(s))}var y=function(n){function e(e,t,i){this.state=e,this.placeholder=t,this.refs={},this.container=i,this.disableDrag=!0,this.placeholder_prepend=!0,n.call(this)}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.getAudioCallStatusText=function(){var e=this.state.audio,t=e.status,i=e.timer;return{timer:i,connected:LSResource.getRealValue("common.connected"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting"),initiated:LSResource.getRealValue("audiovideo.ringing"),mediapermission:LSResource.getRealValue("av.info.waitingformediapermission")}[i?"timer":t]||""},e.prototype.getUI=function(){var e=this.state,t=e.url,i=e.handler,n=e.name,a=e.chid,o=e.audio,r=o&&o.status,c=-1==["initiated","requested"].indexOf(r)&&t&&t(o.media_id,a)||$Support.EmbedObj.clogo,s="initiated"==r,l="mediapermission"==r;return v("div",{class:"cal-wrap",id:"audiocal"},v("div",{class:"posrel dib-mid"},v("div",{class:"cal-widgt theme1 outcal"},v("div",{class:"posrel usr-imginfo"},v("div",{class:"cal-visimg "},v("img",{src:c}))),v("div",{class:"cal-vstrdetl"},v("nav",{class:"cal-actvevstr elips font18"},n&&n(a)||""),v("p",{class:"cal-usrdesc elips"},this.getAudioCallStatusText())),v("div",{class:"cal-optns posrel textR"},v("span",{title:o&&C(o.mute?"unmute":"mute"),id:"audiocall_mute",class:"sqico-"+(o.mute?"muteaudio":"microphone")+" bg-aaa "+(l?"cmn_disable":""),onclick:function(){return l?"":i(a,"audio","mute")}}),v("span",{class:"sqico-call cal-rjct "+(s||l?"cmn_disable":""),id:"audiocall_outgoingend",onclick:function(){return s||l?"":i(a,"audio","reject")}})))))},e.prototype.render=function(){var e=this.state,t=e.isDirectCall,i=e.audio;e.status;return t&&i?this.getUI():""},e}(o);function C(e){var t={mute:LSResource.getRealValue("av.info.mute"),unmute:LSResource.getRealValue("av.info.unmute"),end:LSResource.getRealValue("common.end"),reject:LSResource.getRealValue("common.reject"),screenshare:LSResource.getRealValue("common.screenshare"),swap:LSResource.getRealValue("av.info.swap"),call:LSResource.getRealValue("av.info.call"),cancel:LSResource.getRealValue("common.cancel"),accept:LSResource.getRealValue("common.accept")};return t[e]?t[e]:""}function S(e,t){return"theme4"!=I()?"":v("div",{class:"thme-bgimg",style:"background-image:url("+("Comp"==e?$Support.EmbedObj.clogo:_SCHEMA+"://"+_EMBEDSERVERURL+"/"+_SCREENNAME+"/userimg/"+t.attenderimagefkey+"/photo.ls?nps=404")+")"})}function I(){return window.parent.$ZSIQWidget.getWidgetObject().calltheme||"theme1"}function _(e){return SiqAVRouter.container.detailsHandler.getChatWinObjById(e)}function b(e,t){void 0===e&&(e=0);var i=_(t).attenderimagefkey,n=_SCHEMA+"://"+_EMBEDSERVERURL+"/"+_SCREENNAME+"/userimg/"+i+"/photo.ls?mid="+e;return i?n:$Support.EmbedObj.clogo}function k(e){return A[e]||""}function w(e){var t=this;this.container=e,this.invitations=null,this.ss_invitation={},this.states={},window.onbeforeunload=function(){var e=localStorage.getItem("siq_directcall");if((e=e&&JSON.parse(e))&&(e.is_refreshed=!0,localStorage.setItem("siq_directcall",JSON.stringify(e))),Object.keys(t.states).length)return""}}var A={};function R(){return SiqAVRouter.container.detailsHandler.isEmbed()?$(parent.document.body):$("body")}w.prototype.initiateHeadshot=function(e,t){this.states[e]||(this.states[e]={chid:e,isDirectCall:t},this.states[e].headshot=new l(this.states[e],$("body"),this.container),this.states[e].directCallUI=new y(this.states[e],$("body"),this.container))},w.prototype.updateCallInvitationState=function(e,t,i){var n={audio:{connecting:this.makeAudioCallConnecting,connected:this.makeAudioCallConnected,ended:this.makeAudioCallEnded,cancelled:this.makeAudioCallCancelled,rejected:this.makeAudioCallRejected,missed:this.makeAudioCallMissed,reconnecting:this.makeAudioReconnecting},screen_share:{connecting:this.makeScreenShareConnecting,connected:this.makeScreenShareConnected,ended:this.makeScreenShareEnded,cancelled:this.makeScreenShareCancelled,rejected:this.makeScreenShareRejected,missed:this.makeScreenShareMissed,reconnecting:this.makeScreenShareReconnecting}},a=n[e]&&n[e][i];try{a&&a.call(this,e,t)}catch(e){}},w.prototype.playScreenShareStream=function(e){var t=e.stream,i=(e.mid,e.endCbk,e.chid);this.initiateHeadshot(i);var n=this.states[i];n.screen_share=n.screen_share||{},$.extend(!0,n,{screen_share:{stream:t}});try{n.player||(n.player=new u(n,R(),this.container))}catch(e){}},w.prototype.handleAudioCallInvite=function(e,t){A[t.chid]=_(t.chid).attendername,"audio"==e?(this.showAudioCallInvitation(t),this.invitations=!0):"screen_share"==e&&this.showScreenShareInvitation(t),$(".zsembd_audiocl .sqico-close").click()},w.prototype.clearAudioCallInvite=function(e){var t=this.states[e];t&&t.audio&&delete t.audio,t&&t.screen_share&&delete t.screen_share,this.ss_invitation[e]&&$(this.ss_invitation[e]).remove(),this.__updateState(e),t&&this.__checkAndDestroyInstance(e)},w.prototype.showAudioCallInvitation=function(e){var t=e.chid,i=e.rejectCbk,n=e.acceptCbk,a=e.media_id;this.initiateHeadshot(t);var o=this.states[t];$.extend(!0,o,{handler:this.handleActionHandler.bind(this),name:k,url:b,chid:t,audio:{mute:!1,media_id:a,reject_cbk:i,accept_cbk:n,is_invited:!0,status:"invited"}}),this.__updateState(t),$Support.getParent().$ZSIQChatWindow.openChatWindow()},w.prototype.handleAudioCallInitiate=function(e,t){var i=this,n=t.chid,a=t.cancelCbk,o=t.muteCbk,r=t.media_id,c=t.isDirectCall;c?(this.states[n]=this.states.directcall,delete this.states.directcall):this.initiateHeadshot(n,c),A[n]=_(n).attendername;var s=this.states[n];$(".zsembd_audiocl .sqico-close").click(),$.extend(!0,s,{handler:this.handleActionHandler.bind(this),name:k,url:b,chid:n,audio:{mute:!!c&&s.audio.mute,media_id:r,reject_cbk:a,mute_cbk:function(){o(),$.extend(!0,s,{audio:{mute:!i.states[n].audio.mute}}),i.__updateState(n)},is_invited:!1,status:"requested"}}),this.__updateState(n)},w.prototype.initiateDirectCallUI=function(e){var t=this;void 0===e&&(e=null);function i(){e(),$.extend(!0,o,{audio:{mute:!t.states[n].audio.mute}}),t.__updateState(n)}var n="directcall";if(e){var a=this.states[n];return $.extend(!0,a,{audio:{mute:!1,mute_cbk:i,status:"initiated"}}),void this.__updateState(n)}$("#audiorec,#audiocal").remove(),this.initiateHeadshot(n,!0);var o=this.states[n];$.extend(!0,o,{audio:{mute:!1,mute_cbk:i,status:"mediapermission"}}),this.__updateState(n)},w.prototype.makeAudioCallConnecting=function(e,t){var i=this,n=t.chid,a=t.muteCbk,o=t.rejectCbk,r=(t.media_id,t.name,t.isDirectCall),c=this.states[n];EmbedSound.stop(),A[t.chid]=_(t.chid).attendername,$.extend(!0,c,{isDirectCall:r,audio:{mute_cbk:function(){a(),$.extend(!0,c,{audio:{mute:!i.states[n].audio.mute}}),i.__updateState(n)},reject_cbk:o,status:"connecting"}}),this.__updateState(n),r&&this.stopSoundNotification()},w.prototype.makeAudioCallConnected=function(e,t){t.media_id;var i=t.chid,n=t.callEndCbk,a=t.isDirectCall;EmbedSound.stop(),this.initiateHeadshot(i),this.ss_invitation[i]&&delete this.ss_invitation[i];var o=this.states[i];$.extend(!0,o,{isDirectCall:a,audio:{reject_cbk:n,status:"connected",connected_time:(new Date).getTime()}}),setTimeout(this.startTimer.bind(this,i,e),500),this.__updateState(i)},w.prototype.makeAudioReconnecting=function(e,t){this.__makeReconnecting(e,t)},w.prototype.makeAudioCallEnded=function(e,t){this.__callTerminate(e,t,"ended")},w.prototype.makeAudioCallCancelled=function(e,t){this.__callTerminate(e,t,"cancelled")},w.prototype.makeAudioCallRejected=function(e,t){this.states[t.chid].isDirectCall&&this.container.detailsHandler.initMissedChat(t.chid,"CALLENDED","2",!0),this.__callTerminate(e,t,"rejected")},w.prototype.makeAudioCallMissed=function(e,t){this.__callTerminate(e,t,"missed")},w.prototype.__recordSound=function(e,t){var i=this.container.detailsHandler.isChatExist(e);(1==this.container.detailsHandler.getSupportRepCount(e)&&i||t)&&($("#audiorec").remove(),f(this.container,e,b,k,t))},w.prototype.__callTerminate=function(e,t,i){var n=this,a=t.chid,o=(t.media_id,t.isDirectCall),r=this.states[a],c=r.audio.is_invited;EmbedSound.stop(),r&&r.audio?(this.stopTimer(a,e),this.invitations=c?null:this.invitations,$.extend(!0,r,{audio:{status:i}}),setTimeout(function(){var e=r.isDirectCall;delete r.audio,n.__updateState(a),n.__checkAndDestroyInstance(a),c||-1==["rejected","missed"].indexOf(i)||n.__recordSound(a,e),e&&"ended"==i&&n.implementRatingUI(a),e&&"cancelled"==i&&n.directCallCancelled()},500),this.__updateState(a),o&&(this.stopSoundNotification(),clearTimeout(this.container.detailsHandler.getChatWinObjById(a).waitTimer))):r&&this.__checkAndDestroyInstance(a)},w.prototype.__checkAndDestroyInstance=function(e){try{var t=Object.keys(this.states[e]);0==["audio","screen_share"].filter(function(e){return-1!=t.indexOf(e)}).length&&delete this.states[e]}catch(e){}},w.prototype.showScreenShareInvitation=function(e){var t,i=e.chid,n=e.rejectCbk,a=e.acceptCbk,o=e.media_id;this.initiateHeadshot(i);function r(){$(t).remove(),a()}function c(e){void 0===e&&(e=!0),$(t).remove(),e&&n()}var s,l,d,u,p;l=(s={name:k,acceptHandler:r,rejectHandler:c,chid:i}).name,d=s.acceptHandler,u=s.rejectHandler,p=s.chid,t=m(v("div",{class:"zsiq_popup",id:"zsiqssconfirmbox"},v("div",{class:"zsiq_popupsub"},v("em",{class:"siqico-close zsiq_center",onClick:u}),v("em",{class:"siqico-screenshare zsiq_popuplogo"}),v("div",{class:"zsiq_popup_hdr"},LSResource.getRealValue("common.screenshare")),v("div",{class:"zsiq_popup_desc"},LSResource.getRealValue("screenshare.request.desc",l(p))),v("div",{class:"zsiq_popup_btn zsiq_center"},v("span",{class:"zsiq_center",id:"zsiqconfirmss",onClick:d},LSResource.getRealValue("common.share")),v("span",{class:"zsiq_center zsiq_cancelbtn",id:"zsiqdecliness",onClick:u},LSResource.getRealValue("common.decline")))))),$(R()).append(t),this.ss_invitation[i]={rejectHandler:c,acceptHandler:r,media_id:o,template:t}},w.prototype.showScreenShareMaking=function(e,t){var i=t.chid,n=t.cancelCbk,a=t.media_id;this.initiateHeadshot(i);var o=this.states[i],r=0==this.container.screenShareImpl.getScreenShareType(i,a)?"sharing":"viewing";$.extend(!0,o,{handler:this.handleActionHandler.bind(this),name:k,url:b,chid:i,screen_share:{media_id:a,reject_cbk:n,status:"requested",type:r}}),this.__updateState(i)},w.prototype.makeScreenShareConnecting=function(e,t){var i=t.chid,n=t.muteCbk,a=t.rejectCbk,o=t.media_id;t.name;this.initiateHeadshot(i);var r=this.states[i],c=0==this.container.screenShareImpl.getScreenShareType(i,o)?"sharing":"viewing";$.extend(!0,r,{handler:this.handleActionHandler.bind(this),name:k,url:b,chid:i,screen_share:{media_id:o,mute_cbk:n,reject_cbk:a,status:"connecting",type:c}}),this.__updateState(i)},w.prototype.makeScreenShareConnected=function(e,t){var i=this,n=t.media_id,a=t.chid,o=t.callEndCbk;this.initiateHeadshot(a);var r=this.states[a],c=0==this.container.screenShareImpl.getScreenShareType(a,n)?"sharing":"viewing";$.extend(!0,r,{handler:this.handleActionHandler.bind(this),name:k,url:b,screen_share:{reject_cbk:o,status:"connected",connected_time:(new Date).getTime(),type:c,swap_cbk:function(){return i.__swapScreen(n,a)}}}),setTimeout(this.startTimer.bind(this,a,e),500),this.__updateState(a)},w.prototype.makeScreenShareReconnecting=function(e,t){this.__makeReconnecting(e,t)},w.prototype.makeScreenShareEnded=function(e,t){this.__ssTerminate(e,t,"ended")},w.prototype.makeScreenShareCancelled=function(e,t){this.__ssTerminate(e,t,"cancelled")},w.prototype.makeScreenShareRejected=function(e,t){this.__ssTerminate(e,t,"rejected")},w.prototype.makeScreenShareMissed=function(e,t){this.__ssTerminate(e,t,"missed")},w.prototype.__ssTerminate=function(e,t,i){var n=this,a=t.chid,o=(t.media_id,this.states[a]);this.ss_invitation[a]&&(this.ss_invitation[a].rejectHandler(!1),delete this.ss_invitation[a]),o&&o.screen_share?(this.stopTimer(a,e),$.extend(!0,o,{screen_share:{status:i}}),setTimeout(function(){delete o.screen_share,n.__updateState(a),n.__checkAndDestroyInstance(a)},500),this.__updateState(a)):o&&this.__checkAndDestroyInstance(a)},w.prototype.showDialog=function(){},w.prototype.enableOutingCallUI=function(){},w.prototype.handleActionHandler=function(e,t,i){var n=this.states[e]&&this.states[e][t]&&this.states[e][t][i+"_cbk"];n&&n.call(this)},w.prototype.getTimeDiff=function(e){var t=(new Date).getTime()-e,i=(i=Math.floor(t%36e5/6e4))<10?"0"+i:i,n=(n=Math.floor(t%6e4/1e3))<10?"0"+n:n;return isFinite(i)&&isFinite(n)?i+":"+n:""},w.prototype.startTimer=function(t,i){var n=this;this.states[t][i].timer_ref||(this.states[t][i].timer_ref=setInterval(function(){var e=n.states[t];$.extend(!0,e[i],{timer:n.getTimeDiff(e[i].connected_time)}),n.__updateState(e.chid)},1e3))},w.prototype.stopTimer=function(e,t){var i=this.states[e];clearInterval(i[t].timer_ref),delete i[t].timer,this.__updateState(i.chid)},w.prototype.playSoundNotification=function(e,t){void 0===e&&(e="incomingcall"),void 0===t&&(t="audiocall");var i={type:t,duration:this.container.constants.WAITING_TIME_SECS,tone:e};this.container.detailsHandler.playNotifSound(i)},w.prototype.stopSoundNotification=function(){this.container.detailsHandler.stopNotifSound()},w.prototype.__updateState=function(e){var t=this.states[e];t&&([t.headshot,t.player,t.directCallUI].forEach(function(e){e&&e.updateState()}),this.handleMinimizeState())},w.prototype.__swapScreen=function(e,t){var i=this,n=this.container.detailsHandler.getEncryChid(t),a=_(t),o=m(v("div",{class:"zsiq_video_alert"},v("div",{class:"zsiq_valert_cnt"},"Sharing your screen will close Agent screen sharing"),v("div",{class:"zsiq_btnmain"},v("span",{class:"zsiq_valert_btn",onClick:function(){i.container.screenShareImpl.swapScreenShare({chatid:t,id:e},{chatid:n,wmsid:$Support.EmbedObj.vwmsid,lsuid:a.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid}),$(o).remove()}},"Continue"),v("span",{class:"zsiq_valert_btn zsiq_redbtn",onClick:function(){return $(o).remove()}},"Cancel"))));$(R()).append(o)},w.prototype.__makeReconnecting=function(e,t){var i=t.chid,n=(t.media_id,this.states[i]);this.stopTimer(i,e),n[e].status="reconnecting",this.__updateState(i)},w.prototype.shareScreen=function(e){var t=_(e);this.container.screenShareImpl.startScreenShare({chatid:t.chatID,wmsid:$Support.EmbedObj.vwmsid,lsuid:t.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid})},w.prototype.mediaPermissionUI=function(){var e,t,i=(e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t=m(v("div",{class:"zsiq_prv_main zsiq-cal-turtrp",onClick:function(){return $(t).remove()}},v("div",{class:"zsiq-cal-hnt-cont "+("Chrome"==e?"":"zsiq-"+e)},v("div",{class:"zsiq-trtp-anim"}),v("span",{class:"siqico-arrow zsiq-arrow"}),v("span",{class:"zsiq-alw-mic siqico-mic"}),v("div",{class:"zsiq-alw-mic-desc",html:LSResource.getRealValue("av.info.pleaseallowmicrophone")})))));return $(R()).append(i),function(){return $(i).remove()}},w.prototype.mediaPermissionUnlock=function(){var e,t,i=(e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t=m(v("div",{class:"zsiq_prv_main zsiq-cal-turtrp",onClick:function(){return $(t).remove()}},v("div",{class:"zsiq-cal-hnt-cont zsiq-isblk "+("Chrome"==e?"":"zsiq-"+e)},v("div",{class:"zsiq-trtp-anim "}),v("span",{class:"siqico-arrow zsiq-arrow"}),v("div",{html:LSResource.getRealValue("av.info.pleasetaponlock","<em class='siqico-lock'></em>")}),v("p",null,"(",LSResource.getRealValue("common.or"),")"),v("div",null,LSResource.getRealValue("av.info.enablemicrophonesetting")),v("div",{class:"calndr-sedulbtn",style:"",onclick:g}," ",LSResource.getRealValue("chatwindow.mailcopy.clickhere")," ")))));return $(R()).append(i),$UI.showBanner(LSResource.getRealValue("av.info.microphone.blocked"),!0,null,15e3),function(){return $(i).remove()}},w.prototype.handleCallClash=function(e){e()},w.prototype.handleMinimizeState=function(){var e=this.invitations,t=this.container.commonImpl.getActiveCallData();e||t?($Support.getParent().$ZSIQWidgetUI.updateCallUI(),e?$Support.getParent().$ZSIQWidgetUI.updateIncomingCallUI():$Support.getParent().$ZSIQWidgetUI.removeIncomingCallUI()):$Support.getParent().$ZSIQWidgetUI.removeCallUI()},w.prototype.forceEndCall=function(){for(var e in this.states)this.container.commonImpl.endCallByChid(e),this.container.detailsHandler.triggerIconCheck(e)},w.prototype.implementRatingUI=function(e){var t,i,n=(i=e,m(v("div",{class:"cal-wrap",id:"audiocal"},v("div",{class:"posrel dib-mid"},v("div",{class:"cal-widgt theme1 outcal"},v("div",{class:"posrel usr-imginfo"},v("div",{class:"cal-visimg "},v("img",{src:(t=b)&&t(0,i)}))),v("div",{class:"cal-vstrdetl textC"},v("nav",{class:"cal-actvevstr elips font16"},LSResource.getRealValue("av.info.rating")),v("div",{class:"rating font18"},v("span",{class:"reaction_ico sad_icon","data-reaction":"sad",documentclick:"sendCallRating",title:LSResource.getRealValue("common.sad")}),v("span",{class:"reaction_ico neutral_icon","data-reaction":"neutral",documentclick:"sendCallRating",title:LSResource.getRealValue("common.neutral")}),v("span",{class:"reaction_ico happy_icon","data-reaction":"happy",documentclick:"sendCallRating",title:LSResource.getRealValue("common.happy")})),v("p",{class:"c777 font14"},LSResource.getRealValue("ne.rating.byline"))))))));CallImpl.isCallWithChat=this.container.detailsHandler.getEncryChid(e),SiqAVRouter.chatwinobj=this.container.detailsHandler.getChatWinObjById(e),this.container.detailsHandler.getChatWinObjById(e).hideMaskDiv(),$("#audiorec,#audiocal").remove(),$("body").prepend(n)},w.prototype.implementRatingFdbkUI=function(e){var t,i,n,a,o=(t=e,i=b,n=k,a=ZSIQConversationManager.getChatWinObjById(t.chatID).RCHID,m(v("div",{class:"cal-wrap",id:"audiocal"},v("div",{class:"adocal-cont dtfix "+I()+" cal-oflne",style:"height:354px;"},S(null,t),v("div",{class:"header"},v("div",{class:"actbtn"},v("em",{class:"sqico-min siq-minimize-icon",title:LSResource.getRealValue("ne.title.minimize"),documentclick:"min_iframe"})),v("div",{class:"posrel dib-mid"},v("div",{class:"cal-visimg sqico-user"},v("img",{src:i&&i(0,a)})),v("em",{class:"reaction_ico "+t.rating+"_icon usr-rtng"})),v("div",null,v("div",{class:"cal-cmpname font20 fontB"},n(a)))),v("div",{class:"cal-bodycont posrel"},v("div",{class:"ofln-msg mT5"},$Support.getReactionIndex(t.rating))),v("div",{class:"cal-footer",style:"height:70px;"},v("textarea",{class:"bg-f6 font13 c333 lH20",dockeyup:"feedback",dockeydown:"textarea",id:"fdbkarea","data-validate":"required",placeholder:LSResource.getRealValue("av.info.fdkbckmsg"),autofocus:"",style:"overflow: hidden;"}),v("div",{class:"sqico-calsend fdbak-send msg-send",documentclick:"sendCallFb",title:LSResource.getRealValue("embed.submit")}))))));$($Support.getParent().document.body).find(".siqembed").removeClass("zsiq_size2"),$Support.getParent().$ZSIQWidgetUI.handlefbCall(),$("#audiorec,#audiocal").remove(),$("body").prepend(o)},w.prototype.implementFdbkSuccessUI=function(e){var t,i,n,a,o=(t=e,i=b,n=k,a=ZSIQConversationManager.getChatWinObjById(t.chatID).RCHID,m(v("div",{class:"cal-wrap",id:"audiocal"},v("div",{class:"adocal-cont dtfix "+I()+" cal-oflne"},S(null,t),v("div",{class:"header"},v("div",{class:"actbtn"},v("em",{class:"sqico-min siq-minimize-icon",title:LSResource.getRealValue("ne.title.minimize"),documentclick:"min_iframe"})),v("div",{class:"posrel dib-mid"},v("div",{class:"cal-visimg sqico-user"},v("img",{src:i&&i(0,a)})),v("em",{class:"reaction_ico "+t.rating+"_icon usr-rtng",title:t.rating})),v("div",null,v("div",{class:"cal-cmpname font20 fontB"},n(a)))),v("div",{class:"cal-bodycont posrel"},v("div",{class:"ofln-msg mT5"},LSResource.getRealValue("av.info.ratingandfbk")),v("div",{class:"sqico-call bg-grn mT25 mA",title:LSResource.getRealValue("av.info.callagain"),onclick:function(){return parent.$zohosq.call.start()}}))))));$Support.getParent().$ZSIQWidgetUI.handleMinCall(),$("#audiorec,#audiocal").remove(),$("body").prepend(o)},w.prototype.directCallCancelled=function(){$("#audiorec,#audiocal").remove(),$("body").prepend(CallUIHandler.getCallCancelledHtml()),$($Support.getParent().document.body).find(".siqembed").removeClass("zsiq_size2"),$Support.getParent().$ZSIQWidgetUI.handleMinCall()};function D(e){this.container=e}D.prototype.post=function(e,t,i,n){this.request("POST",e,t,i,n)},D.prototype.get=function(e,t,i){this.request("GET",url,e,t,i)},D.prototype.request=function(e,t,i,n,a){var o=_SCHEMA+"://"+_EMBEDSERVERURL+"/visitor/v2/"+_SCREENNAME+"/"+t;try{$.ajax({url:o,type:e,data:i,success:n||function(){},error:a||function(){}})}catch(e){}};function H(e){this.container=e,this.uiutil=$Support,this.isembed=!0}H.prototype.handleEndSession=function(e,t){this.onGoingCallForChat(e)?this.container.commonImpl.endCallByChid(e,t):t()},H.prototype.onGoingCallForChat=function(e){return!!this.container.commonImpl.getCallStatusByChid(e)},H.prototype.getEncryChid=function(e){return $Support.chidmappinglist[e]},H.prototype.isEmbed=function(){return this.isembed},H.prototype.getChatWinObjById=function(e,t){void 0===t&&(t=!1);var i=t?e:this.getEncryChid(e);return ZSIQConversationManager.getChatWinObjById(i)},H.prototype.getSupportReps=function(e,t){void 0===t&&(t=!1);var i=t?e:this.getEncryChid(e);return SUPPORT_REPS[i]||null},H.prototype.getSupportRepCount=function(e,t){void 0===t&&(t=!1);var i=this.getSupportReps(e,t);return i&&Object.keys(i).length},H.prototype.isGroupConversation=function(e,t){void 0===t&&(t=!1);try{return 1<this.getSupportRepCount(e,t)}catch(e){return!1}},H.prototype.isAttenderBot=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).isBotChat},H.prototype.isChatExist=function(e,t){void 0===t&&(t=!1);var i=this.getChatWinObjById(e,t);return"connected"==i.chatstatus&&!i.isBotChat},H.prototype.getAttenderId=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).attender},H.prototype.isProactiveChat=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).proactive},H.prototype.getCurrentUserId=function(){return null},H.prototype.playNotifSound=function(e){var t=e.tone,i=e.duration,n=e.chatid,a=e.isEncrypted,o=!n||this.getChatWinObjById(n,a);n&&o.isSoundOff()||EmbedSound.play(t,i)},H.prototype.stopNotifSound=function(){EmbedSound.stop()},H.prototype.initMissedChat=function(e,t,i,n){var a=e?this.getChatWinObjById(e):ZSIQConversationManager.getcurrchatwinobj();delete $Support.requestRunning_missedvisitor,this.uiutil.handleMissed(t,i,n,a),this.uiutil.removeWtimeCookie(a.chatID),delete a.reopenwaiting,$Support.removeBroadCast()},H.prototype.clearPlayer=function(){this.getBody().find(".zsiq_video_main").remove()},H.prototype.getBody=function(){return $(parent.document.body)},H.prototype.triggerAudioCallIcon=function(e,t){var i=$("#audiocall");"show"==t?(this.showAudioCall(),i.removeClass("cmn_disable").show(),i.show().parent().addClass("rgt_ico")):"hide"==t?(this.hideAudioCall(),i.hide().parent().removeClass("rgt_ico")):"disable"==t&&(this.showAudioCall(),i.addClass("cmn_disable"))},H.prototype.triggerScreenShareIcon=function(){},H.prototype.showAudioCall=function(){$("#audiocall").show(),$(".callagain-txt").show()},H.prototype.hideAudioCall=function(){$("#audiocall").hide(),$(".callagain-txt").hide(),$("#call_Busy").remove()},H.prototype.isAudioCallEnabled=function(){var e="true"==$Support.getParent().$ZSIQChat.getWidgetData().embedobj.isaudiocallallowed,t="true"==$Support.EmbedObj.eprops.isaudiocall;return e&&t},H.prototype.isPlanAllowed=function(){return Licence.verify("audiocall")},H.prototype.isScreenShareAllowed=function(){return CommonUtil.isScreenshareEnabledFromPortal()&&$Support.EmbedObj.eprops.issiqscreenshare&&Licence.verify("issiqscreenshare")},H.prototype.hasIncomingCall=function(e){var t=this.container.commonImpl.getCallStatusByChid(e);for(var i in t){var n=t[i];if("audio"==n.type&&"incoming"==n.callType&&"ringing"==n.callStatus)return!0}return!1},H.prototype.isActiveBySSType=function(e){var t={isActive:!1,id:null},i=this.container.commonImpl.getActiveCallData();if(!i)return t;if(i==e){var n=this.container.commonImpl.getCallStatusByChid(i);for(var a in n){var o=n[a].type,r=n[a].id;if("screen_share"==o)return t.isActive=!0,t.id=r,t}}return t},H.prototype.isShareScreenAllowed=function(e){if(!this.container.commonImpl.currentUserBrowserSupportSS())return!1;var t=this.isActiveBySSType(e),i=t.isActive,n=t.id;return 0!=this.container.screen_shareImpl.getScreenShareType(e,n)||!i},H.prototype.checkIsSSOnGoing=function(e,t){var i=this.container.commonImpl.getActiveCallData();return!!i&&(i!=e||("share_screen"==t?this.isShareScreenAllowed(e):"view_screen"==t?this.isRequestScreenShareAllowed(e):void 0))},H.prototype.checkActiveScreenShare=function(e,t){var i=this.container.commonImpl.getCallStatusByChid(e);for(var n in i){var a=i[n],o=a.id;if("screen_share"==a.type){var r=this.container.screenShareImpl.getScreenShareType(e,o);if(1==r)return this.container.screenShareImpl.handleUIEnd({type:"screen_share",id:o,chatid:e}),this.container.screenShareImpl.startScreenShare(t),!0;if(0==r)return this.container.screenShareImpl.handleUIEnd({type:"screen_share",id:o,chatid:e}),this.container.screenShareImpl.startScreenShare(t),!0}}return!1},H.prototype.isSecureConnection=function(){return-1<window.location.protocol.indexOf("https")},H.prototype.isAudioRecordingSupported=function(){return window.AudioContext=window.AudioContext||window.webkitAudioContext,window.URL=window.URL||window.webkitURL,navigator.getUserMedia=this.container.MediaPermission.getUserMediaDetail(),window.AudioContext&&navigator.getUserMedia&&window.URL&&window.Worker||(support=!1),!0},H.prototype.closeViewMediaPermission=function(){$(window.parent.document).find("body").find(".zsiq_prv_main").remove()},H.prototype.isliveChatWindow=function(){return"msgarea"==$Support.container.attr("cwview")},H.prototype.isFaceBookIntegration=function(){return-1<window.location.href.lastIndexOf("facebook.ext")},H.prototype.getVisitorWMSID=function(){return this.uiutil.EmbedObj.vwmsid},H.prototype.getLsid=function(){return $Support.getParent().$ZSIQWidget.getWidgetObject().lsid},H.prototype.getVisitorID=function(){},H.prototype.getVisitorBrowser=function(){},H.prototype.getVisitorUserAgent=function(){},H.prototype.getVisitorPage=function(){},H.prototype.getUTSDetail=function(){},H.prototype.isMobileVisitor=function(){},H.prototype.isIOSSDKVisitor=function(){},H.prototype.isChatMonitor=function(){return!1},H.prototype.getCurretUserLSUID=function(){},H.prototype.I18N=function(){},H.prototype.getChatAttender=function(){},H.prototype.isVisitorOnline=function(){},H.prototype.isOngoingChat=function(){return!1},H.prototype.checkBrowserSupported=function(){},H.prototype.getBrowserFromUserAgent=function(){},H.prototype.addVisitorDetail=function(){},H.prototype.pickupsupport=function(){},H.prototype.endSession=function(e){var t=e?this.getChatWinObjById(e):ZSIQConversationManager.getcurrchatwinobj();$Support.quitChat(t)},H.prototype.getChatIdByVisitorId=function(){},H.prototype.isScreenShareEnabled=function(){},H.prototype.sendDebugLogger=function(){},H.prototype.hideAudioCallIcon=function(){},H.prototype.showAudioCallIcon=function(){},H.prototype.disableCallAgainOption=function(){},H.prototype.showCallAgainOption=function(){},H.prototype.removeAudioCallIcon=function(){},H.prototype.isCallIconEnabled=function(){},H.prototype.initVideoPlayer=function(){},H.prototype.isAllowedForCurrTab=function(){},H.prototype.getRepresentative=function(){},H.prototype.isVisitorBrowserSupported=function(){},H.prototype.isVisitorOSSupported=function(){},H.prototype.getVisitorOS=function(){},H.prototype.audioIconStatus=function(){},H.prototype.screenshareIconStatus=function(){},H.prototype.triggerIconCheck=function(e){this.container.audioImpl.audioIconStatus(e,this.triggerAudioCallIcon.bind(this))},H.prototype.focusChatWindow=function(){},H.prototype.joinChat=function(){},H.prototype.canShowAudioCallInvitation=function(){return!0},H.prototype.endCall=function(e,t){this.container.commonImpl.endCallByChid(e,t)},H.prototype.isAudioCallDisabled=function(){return!1},H.prototype.toJSON=function(e){return JSON.stringify(e)};function T(e){this.container=e,this.init(e)}T.prototype.handle=function(e){this.route(e.param)},T.prototype.route=function(e){var t,i,n=e.msg.media,a=n.type,o=n.chatid,r=n.id,c=e.msg,s=c.operation;c.cbtype;this.checkIsCurrentTab(o)||-1!=["call_initiate","call_cancel","call_miss"].indexOf(s)?"function"==typeof(i=(t=this.getController(a))&&t[this.getHandler(e)])&&(i.call(t,e.msg.media),this.container.commonImpl.sendMediaStats(e,null)):(this.container.uiHandler.clearAudioCallInvite(a,r),this.container[a+"Impl"].clearData(e.msg.media),Sound.stop())},T.prototype.init=function(e){this.audio_impl=e.audioImpl,this.video_impl=e.videoImpl,this.screen_share_impl=e.screenShareImpl,this.common_impl=e.commonImpl},T.prototype.getController=function(e){return this[e+"_impl"]},T.prototype.getHandler=function(e){var t=e.msg,i=t.cbtype,n=t.status,a=t.operation,o=this.getStatus(n),r=this.getOperations(a),c=this.getCBTypes(i);return o||r||c},T.prototype.getOperations=function(e){return{call_credential:"setCredential",call_initiate:"handleInvitation",call_accept:"handleCallAccept",call_reject:"handleCallReject",call_candidates:"handleCandidates",call_answer:"handleCallAnswer",call_end:"handleCallEnd",call_offer:"handleCallOffer",call_cancel:"handleCallCancel",call_miss:"handleCallMissed",call_invite:"handleCallInvite"}[e]},T.prototype.getCBTypes=function(){return{credential:"setCredential",invite:"handleInvitation",reject:"handleCallReject",candidate:"handleCandidates",answer:"handleCallAnswer",offer:"handleCallOffer",cancel:"handleCallCancel",miss:"handleCallMissed",invite:"handleCallInvite"}},T.prototype.getStatus=function(e){return{accept:"handleCallAccept",end:"handleCallEnd"}[e]},T.prototype.checkIsCurrentTab=function(){var e=!1,t=this.container.commonImpl.getActiveTab();this.container.commonImpl.getActiveCallData();return t&&(e=!0),e};function q(){this.container=this.container}q.prototype.getEventsMap=function(){return{mute:"",end_media:"",sharescreen:"",shareaudio:"",stop_audio:"",stop_screenshare:""}};function M(e){this.container=e,this.init(e)}M.prototype.handle=function(){},M.prototype.init=function(){};function O(e){this.conatiner=e}O.prototype.handle=function(){};function U(e){((this.container=e).MediaPermission=this).isSupported=void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia,this.displayMediaSupported=this.isSupported&&navigator.mediaDevices.getDisplayMedia&&void 0!==navigator.mediaDevices.getDisplayMedia,this.init(),this.getmediaDevices(this.updateMediaDevices.bind(this),null)}U.prototype.init=function(){this.type={audio:"audio",video:"video",audio_video:"audio_video",screen:"screen_share"},this.streamType={audio:1,video:2,screen:3,audio_video:4},this.streamTypeInString={1:"audio",2:"video",3:"screen_share",4:"audio_video"},this.devicesType={audioInput:"audioinput",videoInput:"videoinput",audioOutput:"audiooutput"}},U.prototype.isDisplayMediaSupported=function(){return this.displayMediaSupported},U.prototype.updateMediaDevices=function(e){this.devicesArray=e;var t=[],i=[];for(var n in this.devicesArray){var a=this.devicesArray[n];a.kind==this.devicesType.audioInput?t.push(a):a.kind==this.devicesType.videoInput&&i.push(a)}this.availableDevices={audioInput:t,videoInput:i}},U.prototype.getAvailableDevices=function(){return this.availableDevices},U.prototype.getmediaDevices=function(t){void 0!==navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices().then(function(e){return t(e)})},U.prototype.updatePreferredDevice=function(e){this.preferredDevice||(this.preferredDevice={}),this.preferredDevice[e.type]=e},U.prototype.getPreferredDevice=function(e){return this.preferredDevice?this.preferredDevice[e]:null},U.prototype.getAudioInputDevices=function(){return this.availableDevices.audioInput},U.prototype.getVideoInputDevices=function(){return this.availableDevices.videoInput},U.prototype.getMediaConstraints=function(e,t){var i={},n=!0,a=!0,o=this.getPreferredDevice(this.devicesType.audioInput),r=this.getPreferredDevice(this.devicesType.videoInput);return o&&(n={deviceId:{exact:o.deviceId}}),r&&(a={deviceId:{exact:r.deviceId}}),i=Object.assign({},{audio:n,video:a},t),e==this.type.audio?i.video=!1:e!=this.type.video&&e!=this.type.screen||(i.audio=!1),i},U.prototype.requestStream=function(i,n,t,e,a,o){var r,c,s=this,l=null;this.streams?l=this.streams[i]:this.streams=[],l?n():(r=a?navigator.mediaDevices.getDisplayMedia:navigator.mediaDevices.getUserMedia,c=this.getMediaConstraints(i,e),r.call(navigator.mediaDevices,c).then(function(e){var t;s.setType(e,i),s.streams[i]=e,"function"!=typeof o||(t=e._getPrimaryVideoTrack())&&(t.onended=o),n()}).catch(function(e){t(e,i)}))},U.prototype.getAudioStream=function(e,t,i,n){this.requestStream(this.type.audio,e,t,i,!1,n)},U.prototype.getVideoStream=function(e,t,i,n){this.requestStream(this.type.video,e,t,i,!1,n)},U.prototype.getScreenShareStream=function(e,t,i,n){var a;this.displayMediaSupported?this.requestStream(this.type.screen,e,t,i,!0,n):(a={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sourceId}}},this.requestStream(this.type.screen,e,t,a,!1,n))},U.prototype.getStreamByType=function(e){return this.streams?this.streams[e]:null},U.prototype.getScreenSharePermissionWithAudio=function(){},U.prototype.getAudioPermission=function(e,t){this.getPermission(this.type.audio,e,t)},U.prototype.getVideoPermission=function(e,t){this.getPermission(this.type.video,e,t)},U.prototype.getPermission=function(e,t,i){navigator.permissions.query({name:e}).then(function(e){"function"==typeof t&&t(e.state)}).catch(function(e){"function"==typeof i&&i(e)})},U.prototype.setType=function(e,t){var i="";return e.salesiq||(i=e.salesiq={}),i._type=t,i},U.prototype.getTypeFromStream=function(e){return e&&e.salesiq&&e.salesiq._type?e.salesiq._type:null},U.prototype.closeAllStream=function(){for(var e in this.streams)this.closeStream(e)},U.prototype.closeStreamByType=function(e){this.closeStream(e)},U.prototype.closeStream=function(e){var t=this.streams?this.streams[e]:null;if(t){var i=t.getTracks();for(var n in i)i[n].stop();this.streams[e]=null}},U.prototype.toggleMute=function(){var e=this.streams[this.type.audio];e.getAudioTracks()[0].enabled=!e.getAudioTracks()[0].enabled},U.prototype.screenEndFromBrowserUI=function(e){this.streams[this.type.screen].getVideoTracks()[0].onended=function(){e()}},U.prototype.getUserMediaDetail=function(){return navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||null};function E(e){this.container=e,this.userAgent=navigator.userAgent,this.browserName=null,this.browserVersion=null,this.browserSupported=!1,(e.MediaDetails=this).platform=navigator.platform,this.setBrowserName()}E.prototype.setBrowserName=function(){var e,t,i,n,a,o=(e=this.userAgent,i="unknown-unknown",-1<(a=(n=e).toLowerCase()).indexOf("msie")?i=(t=n.substring(n.indexOf("MSIE")).split(";")[0]).split(" ")[0].replace("MSIE","IE")+"-"+t.split(" ")[1]:-1<a.indexOf("edge")?i=n.substring(n.indexOf("Edge")).split(" ")[0].replace("/","-"):-1<a.indexOf("safari")&&-1<a.indexOf("version")?i=n.substring(n.indexOf("Safari")).split(" ")[0].split("/")[0]+"-"+n.substring(n.indexOf("Version")).split(" ")[0].split("/")[1]:-1<a.indexOf("opr")||-1<a.indexOf("opera")?-1<a.indexOf("opera")?i=n.substring(n.indexOf("Opera")).split(" ")[0].split("/")[0]+"-"+n.substring(n.indexOf("Version")).split(" ")[0].split("/")[1]:-1<a.indexOf("opr")&&(i=n.substring(n.indexOf("OPR")).split(" ")[0].replace("/","-").replace("OPR","Opera")):-1<a.indexOf("chrome")?i=n.substring(n.indexOf("Chrome")).split(" ")[0].replace("/","-"):-1<a.indexOf("firefox")&&(i=n.substring(n.indexOf("Firefox")).split(" ")[0].replace("/","-")),[i,parseInt(i.split("-")[1])]);this.browserName=o[0],this.browserVersion=o[1]},E.prototype.getBrowserName=function(){return this.browserName},E.prototype.getBrowserVersion=function(){return this.browserVersion},E.prototype.checkBrowserSupported=function(){var e=this.browserName.split("-")[0];return this.browserSupported=!1,"Chrome"==e?this.browserSupported=23<=this.browserVersion:"Firefox"==e?this.browserSupported=22<=this.browserVersion:"Opera"==e?this.browserSupported=18<=this.browserVersion:"Safari"==e&&(this.browserSupported=11<=this.browserVersion),this.browserSupported},E.prototype.getPlatform=function(){return this.platform};function j(e){this.data={},this.container=e,this.unique="SiqMedia_",e.dataHandler=this}j.prototype.get=function(e){this.getLocalKey(e);return this.data[e]},j.prototype.set=function(e,t){this.getLocalKey(e);this.data[e]=t},j.prototype.remove=function(e){this.getLocalKey(e);this.data[e]&&delete this.data[e]},j.prototype.getLocalKey=function(e){return this.unique+e};function L(e){(e.router=this).container=e,this.init(e)}var B={WAITING_TIME:6e4,WAITING_TIME_SECS:60,audio:"audio",video:"video",screen_share:"screen_share",0:"audio",2:"video",1:"screen_share",connecting:"connecting",facebookUrl:"https://facebook.com/pages"};L.prototype.init=function(e){this.rtc_router=new T(e),this.event_router=new q,this.media_router=new M(e),this.action_router=new O(e),this.MediaPermission=new U(e),this.dataHandler=new j(e),this.MediaDetails=new E(e),this.container.constants=B},L.prototype.route=function(e){if(!this.validateRouteObject(e))throw"Media Router Schema Mismatch";this.handle(e)},L.prototype.handle=function(e){try{var t=this[e.type+"_router"];t&&t.handle&&t.handle(e)}catch(e){}},L.prototype.validateRouteObject=function(t){var i={type:"string",module:"string",useCase:"string",param:"object"},n=!0;return Object.keys(i).forEach(function(e){t[e]&&typeof t[e]==i[e]||(n=!1)}),n};function V(e){(e.LSRouter=this).container=e,this.init()}V.prototype.init=function(){var e=this,t=this;this.container;this.routes={0:function(){return e.container.checkDirectCallOnload()},2:t.handleCustomMessage(),29:t.handleAVcall.bind(t),13:t.handleUserStatus.bind(t),113:t.chatEnded.bind(t),35:t.chatEnded.bind(this),114:t.checkForCallIcon.bind(this),14:t.checkForCallIcon.bind(this),15:t.checkForCallIcon.bind(this)}},V.prototype.chatEnded=function(e){var t=e.msg.chid;$("#call_Busy").remove(),this.container.uiHandler.clearAudioCallInvite(t),this.container.detailsHandler.triggerIconCheck(t),this.container.detailsHandler.hideAudioCall()},V.prototype.handleMessage=function(e){var t,i,n=this.routes,a=typeof n[e.mtype];try{"function"==a?n[e.mtype].call(this,e):"object"==a&&(t=this.getModuleName(e),"function"==typeof(i=n[e.mtype][t])&&i.call(this,e))}catch(e){}},V.prototype.handleCustomMessage=function(){var e=this;return{addvisitor:e.showInvitation,acctranschat:e.endCall,closetransfer:e.checkForCallIcon,pickupsupport:e.handlePicksupport,leavesupport:e.endSupport,missedvisitor:e.missedDirectCall,joinsupport:e.joinsupport}},V.prototype.handlePicksupport=function(e){var t=e.msg,i=LSMessanger.getPrd()+"_"+$Support.getParent().$ZSIQWidget.getEmbedObject().pinfo.soid+"_"+t.attender;try{for(var n in SUPPORT_REPS[t.chid])n!=i&&delete SUPPORT_REPS[t.chid][n]}catch(e){}this.checkForCallIcon(e)},V.prototype.handlePresenceMessage=function(){return{}},V.prototype.handleLsOperations=function(e){var t={}[e.msg.msg.mode||JSON.parse(e.msg.msg).mode];"function"==typeof t&&t(e.msg)},V.prototype.handleAVcall=function(e){e.msg.msg=JSON.parse(e.msg.msg),e.msg.msg.media=JSON.parse(e.msg.msg.media),this.container.router.route({type:"rtc",module:e.msg.msg.media.type,useCase:e.msg.msg.cbtype||e.msg.msg.operation,param:e.msg})},V.prototype.getModuleName=function(t){return{2:"msg > module",114:"msg > msg > mode",700:"msg > msg > module"}[t.mtype].trim().split(/\s*\>\s*/g).forEach(function(e){return t=t[e]}),t},V.prototype.showInvitation=function(e){try{var t=e.msg,i=t.media;if(!i)return;var n="";for(var a in i)n=JSON.parse(i[a]).type;this.container[n+"Impl"].handleApiCallInvitation(t)}catch(e){}},V.prototype.missedDirectCall=function(e){var t=e.msg,i=t.media;if(i){for(var n in i){var a=JSON.parse(i[n]),o=a.type,r={chatid:this.container.detailsHandler.getChatIdByVisitorId(t.visitorid),id:a.id,type:o};this.container[o+"Impl"].handleCallCancel(r)}}},V.prototype.checkForCallIcon=function(e){var t=this.container,i=e.msg,n=i.chatid||i.chid;t.detailsHandler.triggerIconCheck(n),t.detailsHandler.isGroupConversation(n)&&$("#call_Busy").remove()},V.prototype.endSupport=function(e){var t=e.msg,i=t.chatid||t.chid;this.container.detailsHandler.removeAudioCallIcon(i),this.endCall(e)},V.prototype.disableAvIcons=function(){},V.prototype.endCall=function(e){try{var t=this.container,i=e.msg,n=i.chatid||i.chid;t.commonImpl.endCallByChid(n),this.checkForCallIcon(e)}catch(e){}},V.prototype.handleUserStatus=function(e){this.checkForCallIcon(e)},V.prototype.joinsupport=function(e){this.checkForCallIcon(e),this.container.commonImpl.checkOnGoingCall()},$(document).ready(function(){var e,o={},t=$Support.getParent();(e=o).commonImpl=new s(e),e.audioImpl=new a(e),e.videoImpl=new c(e),e.screen_shareImpl=new r(e),o.uiHandler=new w(o),o.ajaxHandler=new D(o),o.detailsHandler=new H(o),o.logger=LSDebugger.postDebugInfo,o.lsrouter=new V(o),window.SiqAVRouter=new L(o),window.avUIhandler=o.uiHandler,o.commonImpl.checkOnGoingCall(),o.checkDirectCallOnload=function(){var e,t,i,n,a=localStorage.getItem("siq_directcall");(a=a&&JSON.parse(a))&&(e=a.chid,t=a.media_id,i=a.type,"outgoing"==(n=a.status)?($Support.audioid=t,o.commonImpl.makeCallMissed(i,t),o.detailsHandler.initMissedChat(e,"CALLENDED","2",!0)):"connected"==n&&(o.audioImpl.endOngoingCall(e,t),o.detailsHandler.endSession(e)),localStorage.removeItem("siq_directcall"))},!$Support.isChatExist()&&t.$zohosq.values.initiatecall&&t.$zohosq.call.start()})}();
